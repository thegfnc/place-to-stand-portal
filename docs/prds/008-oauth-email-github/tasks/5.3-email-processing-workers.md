# Task 5.3: Email Processing Workers (Raw, Summarize, Classify, Link)

## Overview

Implement background workers that pull emails (via Gmail integration) or receive webhooks, store raw payloads, summarize and classify content, and route messages into client-owned threads via the ingestion API.

## Dependencies

- 1.4 (Gmail API Client)
- 2.3 (Email Metadata Schema)
- 5.1 (Threads and Messages Schema)

## Deliverables

1) Job definitions (Supabase Queues)

- `email.sync.pull` – pulls new messages for connected mailboxes, writes to `email_raw`, enqueues `email.process.classify` and `email.process.summarize`.
- `email.process.summarize` – generates a concise summary and entities → `email_summaries`.
- `email.process.classify` – assigns a category with confidence → `email_classifications`.
- `email.route.message` – posts to `POST /api/v1/messages/ingest` with type `email` (idempotent by Gmail id), linking to the appropriate client/thread.

2) Storage & parsing

- Persist full RFC822 payload to `email_raw.raw_rfc822` and headers map to `email_raw.headers_json`.
- Extract participants (from/to/cc), subject, date; detect attachments and record a manifest for later retrieval.

3) Client linking

- Resolve client via known identity links (5.6). If unknown, enqueue a review task and attach message to a temporary unassigned thread or create a new thread under a default “Inbox” client bucket for triage.

4) AI integrations

- Use Vercel AI Gateway for classification/summarization. Store model and token usage metadata (but redact sensitive content in logs). Follow retry/backoff policies; never block routing on AI failures.

5) Error handling & observability

- Log structured events with request/job id; capture errors in Sentry with minimal PII. Mark poison messages and move to a dead-letter queue after N retries.

## Acceptance Criteria

- New emails appear as `messages` of type `email` on appropriate threads without duplication.
- Raw email, summary, and classification are persisted and linked.
- Failures do not drop data; retries and DLQ configured.

## Files Changed

- `lib/workers/email-sync.ts` (new)
- `lib/workers/email-process.ts` (new)
- `lib/workers/email-route.ts` (new)
- `lib/gmail/client.ts` (reused; no breaking changes)

## Notes

- Keep workers idempotent and side-effect free where possible; rely on unique constraints and idempotency keys.
- Attachments can be fetched/stored later; capture only the manifest now to keep scope contained.


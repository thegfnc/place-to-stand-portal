# Task 1.1: OAuth Token Encryption Utilities

## Overview
Create encryption utilities for securely storing OAuth tokens (access tokens, refresh tokens) in the database.

## Dependencies
- None (this is the foundation task)

## Deliverables

### 1. Create `/lib/oauth/encryption.ts`

```typescript
import { createCipheriv, createDecipheriv, randomBytes } from 'crypto'

const ALGORITHM = 'aes-256-gcm'

function getEncryptionKey(): Buffer {
  const key = process.env.OAUTH_TOKEN_ENCRYPTION_KEY
  if (!key) {
    throw new Error('OAUTH_TOKEN_ENCRYPTION_KEY environment variable is required')
  }
  return Buffer.from(key, 'base64')
}

/**
 * Encrypts a token using AES-256-GCM
 * Returns base64-encoded string containing: IV (16 bytes) + Auth Tag (16 bytes) + Encrypted data
 */
export function encryptToken(token: string): string {
  const key = getEncryptionKey()
  const iv = randomBytes(16)
  const cipher = createCipheriv(ALGORITHM, key, iv)

  const encrypted = Buffer.concat([
    cipher.update(token, 'utf8'),
    cipher.final()
  ])
  const authTag = cipher.getAuthTag()

  // Combine: IV + AuthTag + EncryptedData
  return Buffer.concat([iv, authTag, encrypted]).toString('base64')
}

/**
 * Decrypts a token encrypted with encryptToken()
 */
export function decryptToken(encryptedToken: string): string {
  const key = getEncryptionKey()
  const data = Buffer.from(encryptedToken, 'base64')

  // Extract parts: IV (16 bytes) + AuthTag (16 bytes) + EncryptedData (rest)
  const iv = data.subarray(0, 16)
  const authTag = data.subarray(16, 32)
  const encrypted = data.subarray(32)

  const decipher = createDecipheriv(ALGORITHM, key, iv)
  decipher.setAuthTag(authTag)

  return Buffer.concat([
    decipher.update(encrypted),
    decipher.final()
  ]).toString('utf8')
}
```

### 2. Add environment variable to `/lib/env.server.ts`

Add this to the Zod schema:
```typescript
OAUTH_TOKEN_ENCRYPTION_KEY: z.string().min(32, 'Encryption key must be at least 32 characters (base64)'),
```

And to the parse object:
```typescript
OAUTH_TOKEN_ENCRYPTION_KEY: process.env.OAUTH_TOKEN_ENCRYPTION_KEY,
```

### 3. Update `.env.example`

Add:
```bash
# OAuth Token Encryption (generate with: openssl rand -base64 32)
OAUTH_TOKEN_ENCRYPTION_KEY=
```

## Testing

Create a simple test to verify encryption/decryption works:

```typescript
// Manual test (run in Node REPL or test file)
import { encryptToken, decryptToken } from '@/lib/oauth/encryption'

const original = 'ya29.test-token-12345'
const encrypted = encryptToken(original)
const decrypted = decryptToken(encrypted)

console.assert(decrypted === original, 'Decryption should match original')
console.assert(encrypted !== original, 'Encrypted should differ from original')
console.log('Encryption test passed!')
```

## Acceptance Criteria

- [ ] `encryptToken()` returns a base64 string different from input
- [ ] `decryptToken()` returns the original string
- [ ] Missing env var throws clear error
- [ ] Invalid encrypted data throws error (not silent failure)
- [ ] Environment variable added to `.env.example`
- [ ] Zod validation added to `env.server.ts`

## Files Changed
- `lib/oauth/encryption.ts` (new)
- `lib/env.server.ts` (modified)
- `.env.example` (modified)

## Notes
- Use `openssl rand -base64 32` to generate a secure key
- Never log or expose the encryption key
- This uses AES-256-GCM which provides both encryption and authentication

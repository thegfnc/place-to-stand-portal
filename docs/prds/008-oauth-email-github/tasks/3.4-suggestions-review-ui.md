# Task 3.4: Suggestions Review UI

## Overview
Create the UI for reviewing and approving/rejecting AI-generated task suggestions.

## Dependencies
- Task 3.3 (Suggestions API)

## Design System Reference

Use existing patterns:
- Card layout for suggestion items
- Sheet for editing before approval
- Badge for confidence/status
- SearchableCombobox for project selection
- Toast for notifications
- ConfirmDialog for rejections

## Deliverables

### 1. Create `/app/(dashboard)/suggestions/page.tsx`

```typescript
import { requireRole } from '@/lib/auth/session'
import { getPendingSuggestions, getSuggestionCounts } from '@/lib/data/suggestions'
import { SuggestionsPanel } from './_components/suggestions-panel'

export default async function SuggestionsPage() {
  await requireRole('ADMIN')

  const [suggestions, counts] = await Promise.all([
    getPendingSuggestions({ limit: 50 }),
    getSuggestionCounts(),
  ])

  return (
    <div className='space-y-6'>
      <div>
        <h1 className='text-2xl font-semibold'>Task Suggestions</h1>
        <p className='text-muted-foreground'>
          Review AI-generated task suggestions from client emails.
        </p>
      </div>
      <SuggestionsPanel initialSuggestions={suggestions} initialCounts={counts} />
    </div>
  )
}
```

### 2. Create `/app/(dashboard)/suggestions/_components/suggestions-panel.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Inbox, CheckCircle2, XCircle, Sparkles } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { useToast } from '@/components/ui/use-toast'
import type { TaskSuggestionWithEmail } from '@/lib/types/suggestions'
import { SuggestionCard } from './suggestion-card'
import { SuggestionEditSheet } from './suggestion-edit-sheet'

interface SuggestionsPanelProps {
  initialSuggestions: TaskSuggestionWithEmail[]
  initialCounts: { pending: number; approved: number; rejected: number }
}

export function SuggestionsPanel({
  initialSuggestions,
  initialCounts,
}: SuggestionsPanelProps) {
  const router = useRouter()
  const { toast } = useToast()
  const [suggestions, setSuggestions] = useState(initialSuggestions)
  const [counts, setCounts] = useState(initialCounts)
  const [selected, setSelected] = useState<string[]>([])
  const [editingSuggestion, setEditingSuggestion] = useState<TaskSuggestionWithEmail | null>(null)
  const [processing, setProcessing] = useState(false)

  const handleApprove = async (suggestion: TaskSuggestionWithEmail) => {
    setEditingSuggestion(suggestion)
  }

  const handleQuickApprove = async (suggestionId: string) => {
    setProcessing(true)
    try {
      const response = await fetch(`/api/suggestions/${suggestionId}/approve`, {
        method: 'POST',
      })

      if (!response.ok) throw new Error('Failed to approve')

      setSuggestions(prev => prev.filter(s => s.id !== suggestionId))
      setCounts(prev => ({ ...prev, pending: prev.pending - 1, approved: prev.approved + 1 }))

      toast({ title: 'Task created', description: 'Suggestion approved and task created.' })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to approve suggestion.', variant: 'destructive' })
    } finally {
      setProcessing(false)
    }
  }

  const handleReject = async (suggestionId: string, reason?: string) => {
    setProcessing(true)
    try {
      const response = await fetch(`/api/suggestions/${suggestionId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason }),
      })

      if (!response.ok) throw new Error('Failed to reject')

      setSuggestions(prev => prev.filter(s => s.id !== suggestionId))
      setCounts(prev => ({ ...prev, pending: prev.pending - 1, rejected: prev.rejected + 1 }))

      toast({ title: 'Suggestion rejected' })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to reject suggestion.', variant: 'destructive' })
    } finally {
      setProcessing(false)
    }
  }

  const handleBulkAction = async (action: 'approve' | 'reject') => {
    if (selected.length === 0) return

    setProcessing(true)
    try {
      const response = await fetch('/api/suggestions/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, suggestionIds: selected }),
      })

      const result = await response.json()

      setSuggestions(prev => prev.filter(s => !selected.includes(s.id)))
      setCounts(prev => ({
        ...prev,
        pending: prev.pending - result.succeeded,
        [action === 'approve' ? 'approved' : 'rejected']: prev[action === 'approve' ? 'approved' : 'rejected'] + result.succeeded,
      }))
      setSelected([])

      toast({
        title: `${result.succeeded} suggestions ${action}d`,
        description: result.failed > 0 ? `${result.failed} failed` : undefined,
      })
    } catch (error) {
      toast({ title: 'Error', description: 'Bulk action failed.', variant: 'destructive' })
    } finally {
      setProcessing(false)
    }
  }

  const handleEditComplete = (approved: boolean) => {
    if (approved && editingSuggestion) {
      setSuggestions(prev => prev.filter(s => s.id !== editingSuggestion.id))
      setCounts(prev => ({ ...prev, pending: prev.pending - 1, approved: prev.approved + 1 }))
    }
    setEditingSuggestion(null)
  }

  const toggleSelect = (id: string) => {
    setSelected(prev =>
      prev.includes(id) ? prev.filter(s => s !== id) : [...prev, id]
    )
  }

  const toggleSelectAll = () => {
    setSelected(prev =>
      prev.length === suggestions.length ? [] : suggestions.map(s => s.id)
    )
  }

  return (
    <div className='space-y-4'>
      {/* Stats */}
      <div className='flex gap-4'>
        <Badge variant='outline' className='text-sm'>
          <Inbox className='mr-1 h-3 w-3' />
          {counts.pending} pending
        </Badge>
        <Badge variant='outline' className='text-sm text-green-600'>
          <CheckCircle2 className='mr-1 h-3 w-3' />
          {counts.approved} approved
        </Badge>
        <Badge variant='outline' className='text-sm text-red-600'>
          <XCircle className='mr-1 h-3 w-3' />
          {counts.rejected} rejected
        </Badge>
      </div>

      {/* Bulk Actions */}
      {selected.length > 0 && (
        <div className='flex items-center gap-2 p-3 bg-muted rounded-lg'>
          <span className='text-sm'>{selected.length} selected</span>
          <Button
            size='sm'
            onClick={() => handleBulkAction('approve')}
            disabled={processing}
          >
            Approve All
          </Button>
          <Button
            size='sm'
            variant='outline'
            onClick={() => handleBulkAction('reject')}
            disabled={processing}
          >
            Reject All
          </Button>
          <Button size='sm' variant='ghost' onClick={() => setSelected([])}>
            Clear
          </Button>
        </div>
      )}

      {/* Suggestion List */}
      {suggestions.length === 0 ? (
        <div className='rounded-lg border border-dashed p-8 text-center'>
          <Sparkles className='mx-auto h-8 w-8 text-muted-foreground' />
          <p className='mt-2 text-sm text-muted-foreground'>
            No pending suggestions. Analyze more emails to generate task suggestions.
          </p>
        </div>
      ) : (
        <div className='space-y-3'>
          <div className='flex items-center justify-between'>
            <Button variant='ghost' size='sm' onClick={toggleSelectAll}>
              {selected.length === suggestions.length ? 'Deselect All' : 'Select All'}
            </Button>
          </div>
          {suggestions.map(suggestion => (
            <SuggestionCard
              key={suggestion.id}
              suggestion={suggestion}
              selected={selected.includes(suggestion.id)}
              onSelect={() => toggleSelect(suggestion.id)}
              onApprove={() => handleApprove(suggestion)}
              onQuickApprove={() => handleQuickApprove(suggestion.id)}
              onReject={(reason) => handleReject(suggestion.id, reason)}
              disabled={processing}
            />
          ))}
        </div>
      )}

      {/* Edit Sheet */}
      <SuggestionEditSheet
        suggestion={editingSuggestion}
        onClose={() => setEditingSuggestion(null)}
        onComplete={handleEditComplete}
      />
    </div>
  )
}
```

### 3. Create `/app/(dashboard)/suggestions/_components/suggestion-card.tsx`

```typescript
'use client'

import { useState } from 'react'
import { Mail, Calendar, Building2, FolderKanban, MoreVertical } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Checkbox } from '@/components/ui/checkbox'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { ConfirmDialog } from '@/components/ui/confirm-dialog'
import type { TaskSuggestionWithEmail } from '@/lib/types/suggestions'
import { formatDistanceToNow } from 'date-fns'

interface SuggestionCardProps {
  suggestion: TaskSuggestionWithEmail
  selected: boolean
  onSelect: () => void
  onApprove: () => void
  onQuickApprove: () => void
  onReject: (reason?: string) => void
  disabled?: boolean
}

export function SuggestionCard({
  suggestion,
  selected,
  onSelect,
  onApprove,
  onQuickApprove,
  onReject,
  disabled,
}: SuggestionCardProps) {
  const [rejectDialogOpen, setRejectDialogOpen] = useState(false)

  const confidencePercent = Math.round(Number(suggestion.confidence) * 100)
  const confidenceColor =
    confidencePercent >= 80 ? 'text-green-600' :
    confidencePercent >= 60 ? 'text-amber-600' : 'text-red-600'

  return (
    <>
      <Card className={selected ? 'ring-2 ring-primary' : ''}>
        <CardHeader className='pb-2'>
          <div className='flex items-start gap-3'>
            <Checkbox
              checked={selected}
              onCheckedChange={onSelect}
              className='mt-1'
            />
            <div className='flex-1 min-w-0'>
              <CardTitle className='text-base font-medium'>
                {suggestion.suggestedTitle}
              </CardTitle>
              <div className='flex flex-wrap items-center gap-2 mt-1 text-sm text-muted-foreground'>
                <span className='flex items-center gap-1'>
                  <Mail className='h-3 w-3' />
                  {suggestion.email.subject || '(no subject)'}
                </span>
                <span>·</span>
                <span>{suggestion.email.fromEmail}</span>
                <span>·</span>
                <span>{formatDistanceToNow(new Date(suggestion.email.receivedAt))} ago</span>
              </div>
            </div>
            <Badge className={confidenceColor} variant='outline'>
              {confidencePercent}% confidence
            </Badge>
          </div>
        </CardHeader>
        <CardContent className='pt-0'>
          {suggestion.suggestedDescription && (
            <p className='text-sm text-muted-foreground mb-3 line-clamp-2'>
              {suggestion.suggestedDescription}
            </p>
          )}

          <div className='flex items-center gap-4 text-sm mb-3'>
            {suggestion.project && (
              <span className='flex items-center gap-1'>
                <FolderKanban className='h-3 w-3' />
                {suggestion.project.name}
              </span>
            )}
            {suggestion.suggestedDueDate && (
              <span className='flex items-center gap-1'>
                <Calendar className='h-3 w-3' />
                {suggestion.suggestedDueDate}
              </span>
            )}
            {suggestion.suggestedPriority && (
              <Badge variant='secondary' className='text-xs'>
                {suggestion.suggestedPriority}
              </Badge>
            )}
          </div>

          {suggestion.reasoning && (
            <p className='text-xs text-muted-foreground italic mb-3'>
              "{suggestion.reasoning}"
            </p>
          )}

          <div className='flex items-center justify-end gap-2'>
            <Button
              size='sm'
              variant='outline'
              onClick={() => setRejectDialogOpen(true)}
              disabled={disabled}
            >
              Reject
            </Button>
            <Button
              size='sm'
              variant='outline'
              onClick={onApprove}
              disabled={disabled}
            >
              Edit & Approve
            </Button>
            <Button
              size='sm'
              onClick={onQuickApprove}
              disabled={disabled || !suggestion.projectId}
            >
              Quick Approve
            </Button>
          </div>
        </CardContent>
      </Card>

      <ConfirmDialog
        open={rejectDialogOpen}
        title='Reject suggestion?'
        description={`This will reject the suggestion "${suggestion.suggestedTitle}". This action cannot be undone.`}
        confirmLabel='Reject'
        cancelLabel='Cancel'
        confirmVariant='destructive'
        onConfirm={() => {
          onReject()
          setRejectDialogOpen(false)
        }}
        onCancel={() => setRejectDialogOpen(false)}
      />
    </>
  )
}
```

### 4. Create `/app/(dashboard)/suggestions/_components/suggestion-edit-sheet.tsx`

```typescript
'use client'

import { useEffect, useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from '@/components/ui/sheet'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { SearchableCombobox } from '@/components/ui/searchable-combobox'
import { useToast } from '@/components/ui/use-toast'
import type { TaskSuggestionWithEmail } from '@/lib/types/suggestions'

const editSchema = z.object({
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().max(2000).optional(),
  projectId: z.string().uuid('Select a project'),
  dueDate: z.string().optional(),
  priority: z.enum(['HIGH', 'MEDIUM', 'LOW']).optional(),
})

type EditFormValues = z.infer<typeof editSchema>

interface SuggestionEditSheetProps {
  suggestion: TaskSuggestionWithEmail | null
  onClose: () => void
  onComplete: (approved: boolean) => void
}

export function SuggestionEditSheet({
  suggestion,
  onClose,
  onComplete,
}: SuggestionEditSheetProps) {
  const { toast } = useToast()
  const [projects, setProjects] = useState<Array<{ value: string; label: string }>>([])

  const form = useForm<EditFormValues>({
    resolver: zodResolver(editSchema),
    defaultValues: {
      title: '',
      description: '',
      projectId: '',
      dueDate: '',
      priority: undefined,
    },
  })

  useEffect(() => {
    fetch('/api/projects')
      .then(r => r.json())
      .then(data => setProjects(data.map((p: any) => ({ value: p.id, label: p.name }))))
  }, [])

  useEffect(() => {
    if (suggestion) {
      form.reset({
        title: suggestion.suggestedTitle,
        description: suggestion.suggestedDescription || '',
        projectId: suggestion.projectId || '',
        dueDate: suggestion.suggestedDueDate || '',
        priority: suggestion.suggestedPriority as 'HIGH' | 'MEDIUM' | 'LOW' | undefined,
      })
    }
  }, [suggestion, form])

  const onSubmit = async (values: EditFormValues) => {
    if (!suggestion) return

    try {
      const response = await fetch(`/api/suggestions/${suggestion.id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values),
      })

      if (!response.ok) throw new Error('Failed to approve')

      toast({ title: 'Task created', description: 'Suggestion approved with your edits.' })
      onComplete(true)
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to create task.', variant: 'destructive' })
    }
  }

  if (!suggestion) return null

  return (
    <Sheet open={!!suggestion} onOpenChange={() => onClose()}>
      <SheetContent className='w-[500px] sm:max-w-[500px]'>
        <SheetHeader>
          <SheetTitle>Edit & Approve Suggestion</SheetTitle>
          <SheetDescription>
            Review and modify the task details before creating.
          </SheetDescription>
        </SheetHeader>

        <div className='mt-4 p-3 bg-muted rounded-md text-sm'>
          <p className='font-medium'>Source Email:</p>
          <p className='text-muted-foreground'>{suggestion.email.subject}</p>
          <p className='text-xs text-muted-foreground'>{suggestion.email.fromEmail}</p>
        </div>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className='mt-6 space-y-4'>
            <FormField
              control={form.control}
              name='title'
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Task Title</FormLabel>
                  <FormControl>
                    <Input {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name='description'
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Description</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name='projectId'
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Project</FormLabel>
                  <FormControl>
                    <SearchableCombobox
                      items={projects}
                      value={field.value}
                      onChange={field.onChange}
                      placeholder='Select project...'
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className='grid grid-cols-2 gap-4'>
              <FormField
                control={form.control}
                name='dueDate'
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Due Date</FormLabel>
                    <FormControl>
                      <Input {...field} type='date' />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name='priority'
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Priority</FormLabel>
                    <Select value={field.value} onValueChange={field.onChange}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder='Select...' />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value='HIGH'>High</SelectItem>
                        <SelectItem value='MEDIUM'>Medium</SelectItem>
                        <SelectItem value='LOW'>Low</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className='flex justify-end gap-2 pt-4'>
              <Button type='button' variant='outline' onClick={onClose}>
                Cancel
              </Button>
              <Button type='submit' disabled={form.formState.isSubmitting}>
                {form.formState.isSubmitting ? (
                  <>
                    <Loader2 className='mr-2 h-4 w-4 animate-spin' />
                    Creating...
                  </>
                ) : (
                  'Create Task'
                )}
              </Button>
            </div>
          </form>
        </Form>
      </SheetContent>
    </Sheet>
  )
}
```

### 5. Add navigation link

Add "Suggestions" link to sidebar with pending count badge.

## Acceptance Criteria

- [ ] List view shows pending suggestions with email context
- [ ] Confidence score displayed with color coding
- [ ] Quick approve creates task immediately
- [ ] Edit & Approve opens sheet for modifications
- [ ] Reject shows confirmation dialog
- [ ] Bulk select and action works
- [ ] Empty state when no pending suggestions
- [ ] Stats badges show counts
- [ ] Toast notifications for all actions
- [ ] Loading states during operations

## Files Changed
- `app/(dashboard)/suggestions/page.tsx` (new)
- `app/(dashboard)/suggestions/_components/suggestions-panel.tsx` (new)
- `app/(dashboard)/suggestions/_components/suggestion-card.tsx` (new)
- `app/(dashboard)/suggestions/_components/suggestion-edit-sheet.tsx` (new)
- Navigation component (modified - add Suggestions link)

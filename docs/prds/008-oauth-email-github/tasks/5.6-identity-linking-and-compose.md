# Task 5.6: Identity Linking & Compose-from-Portal

## Overview

Establish robust identity linking between email addresses and clients, and enable composing emails from within the portal so future messages are automatically linked to the correct client/thread.

## Dependencies

- 1.3 (Google OAuth Flow)
- 2.1 (Client Contacts Schema)

## Deliverables

1) Identity linking model

- Use/reuse a join table to link `email_address` ↔ `client_id` (and optionally `person_id`).
- On first manual association in the UI, create the link so future ingested messages auto-resolve `clientId`.

2) Auto-linking rules

- If a user composes an email from the portal and selects a client, all future replies from that email address(es) should be auto-linked to the same client.
- Allow overrides in the UI when ambiguity is detected.

3) Compose email from portal

- Add a compose action in Threads UI for `type = email` that sends via connected Gmail account (existing Gmail integration).
- Store the portal-sent message via the ingestion endpoint with `source = portal` and `type = email`.
- When Gmail later syncs the same message, idempotency prevents duplicates (match by Gmail `externalId`).

4) Security & permissions

- Enforce server-side permission checks for composing/sending and linking changes. Audit-link creations and overrides.

## Acceptance Criteria

- Linking created automatically when composing from the portal and selecting a client.
- Subsequent inbound emails from the same address auto-link to the appropriate client/thread.
- Users can adjust links with safe fallbacks if mis-linked.

## Files Changed

- `lib/queries/identity-linking.ts` (new)
- `app/(dashboard)/clients/[clientId]/threads/[threadId]/compose-email.tsx` (new)
- `app/api/v1/messages/ingest/route.ts` (reused) – no duplication when Gmail syncs

## Notes

- Keep the linking logic deterministic and explainable; prefer transparent rules over opaque heuristics.
- Add subtle UI hints when a message was auto-linked and provide a one-click “Change” affordance.


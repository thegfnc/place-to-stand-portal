# Task 4.5: PR Suggestions UI

## Overview
Create the UI for reviewing, editing, and approving PR suggestions to create actual GitHub PRs.

## Dependencies
- Task 4.4 (PR Suggestions AI)

## Deliverables

### 1. Create `/lib/data/pr-suggestions/index.ts`

```typescript
import { eq, and, isNull, desc, inArray } from 'drizzle-orm'
import { db } from '@/lib/db'
import { prSuggestions, githubRepoLinks, emailMetadata } from '@/lib/db/schema'
import { createPullRequest } from '@/lib/github/client'
import { logActivity } from '@/lib/activity/logger'
import type { PRSuggestionWithContext } from '@/lib/types/github'

/**
 * Get pending PR suggestions
 */
export async function getPendingPRSuggestions(
  options: { limit?: number } = {}
): Promise<PRSuggestionWithContext[]> {
  const { limit = 50 } = options

  const results = await db
    .select({
      suggestion: prSuggestions,
      repoFullName: githubRepoLinks.repoFullName,
      defaultBranch: githubRepoLinks.defaultBranch,
      emailSubject: emailMetadata.subject,
      emailFromEmail: emailMetadata.fromEmail,
    })
    .from(prSuggestions)
    .innerJoin(githubRepoLinks, eq(githubRepoLinks.id, prSuggestions.githubRepoLinkId))
    .leftJoin(emailMetadata, eq(emailMetadata.id, prSuggestions.emailMetadataId))
    .where(
      and(
        inArray(prSuggestions.status, ['DRAFT', 'PENDING']),
        isNull(prSuggestions.deletedAt)
      )
    )
    .orderBy(desc(prSuggestions.createdAt))
    .limit(limit)

  return results.map(r => ({
    ...r.suggestion,
    repoLink: {
      repoFullName: r.repoFullName,
      defaultBranch: r.defaultBranch,
    },
    email: r.emailSubject ? {
      subject: r.emailSubject,
      fromEmail: r.emailFromEmail!,
    } : null,
  }))
}

/**
 * Get single PR suggestion
 */
export async function getPRSuggestionById(
  suggestionId: string
): Promise<PRSuggestionWithContext | null> {
  const [result] = await db
    .select({
      suggestion: prSuggestions,
      repoFullName: githubRepoLinks.repoFullName,
      defaultBranch: githubRepoLinks.defaultBranch,
      repoOwner: githubRepoLinks.repoOwner,
      repoName: githubRepoLinks.repoName,
      emailSubject: emailMetadata.subject,
      emailFromEmail: emailMetadata.fromEmail,
    })
    .from(prSuggestions)
    .innerJoin(githubRepoLinks, eq(githubRepoLinks.id, prSuggestions.githubRepoLinkId))
    .leftJoin(emailMetadata, eq(emailMetadata.id, prSuggestions.emailMetadataId))
    .where(eq(prSuggestions.id, suggestionId))
    .limit(1)

  if (!result) return null

  return {
    ...result.suggestion,
    repoLink: {
      repoFullName: result.repoFullName,
      defaultBranch: result.defaultBranch,
    },
    email: result.emailSubject ? {
      subject: result.emailSubject,
      fromEmail: result.emailFromEmail!,
    } : null,
  }
}

/**
 * Approve PR suggestion and create GitHub PR
 */
export async function approvePRSuggestion(
  suggestionId: string,
  userId: string,
  modifications?: {
    title?: string
    body?: string
    branch?: string
    baseBranch?: string
  }
): Promise<{ prNumber: number; prUrl: string }> {
  // Get suggestion with repo info
  const [result] = await db
    .select({
      suggestion: prSuggestions,
      repoOwner: githubRepoLinks.repoOwner,
      repoName: githubRepoLinks.repoName,
      repoFullName: githubRepoLinks.repoFullName,
    })
    .from(prSuggestions)
    .innerJoin(githubRepoLinks, eq(githubRepoLinks.id, prSuggestions.githubRepoLinkId))
    .where(eq(prSuggestions.id, suggestionId))
    .limit(1)

  if (!result) throw new Error('Suggestion not found')

  const suggestion = result.suggestion

  if (!['DRAFT', 'PENDING'].includes(suggestion.status)) {
    throw new Error('Suggestion already processed')
  }

  const finalTitle = modifications?.title ?? suggestion.suggestedTitle
  const finalBody = modifications?.body ?? suggestion.suggestedBody
  const finalBranch = modifications?.branch ?? suggestion.suggestedBranch
  const finalBaseBranch = modifications?.baseBranch ?? suggestion.suggestedBaseBranch ?? 'main'

  if (!finalBranch) {
    throw new Error('Branch name is required')
  }

  try {
    // Create PR on GitHub
    const pr = await createPullRequest(
      userId,
      result.repoOwner,
      result.repoName,
      {
        title: finalTitle,
        body: finalBody,
        head: finalBranch,
        base: finalBaseBranch,
      }
    )

    // Update suggestion
    await db
      .update(prSuggestions)
      .set({
        status: 'APPROVED',
        reviewedBy: userId,
        reviewedAt: new Date().toISOString(),
        createdPrNumber: pr.number,
        createdPrUrl: pr.html_url,
        updatedAt: new Date().toISOString(),
      })
      .where(eq(prSuggestions.id, suggestionId))

    // Log activity
    await logActivity({
      actorId: userId,
      actorRole: 'ADMIN',
      verb: 'PR_CREATED_FROM_SUGGESTION',
      summary: `Created PR #${pr.number} on ${result.repoFullName}`,
      targetType: 'PROJECT',
      targetId: suggestionId,
      metadata: {
        prNumber: pr.number,
        prUrl: pr.html_url,
        repoFullName: result.repoFullName,
      },
    })

    return { prNumber: pr.number, prUrl: pr.html_url }
  } catch (error) {
    // Update suggestion with error
    await db
      .update(prSuggestions)
      .set({
        status: 'FAILED',
        errorMessage: error instanceof Error ? error.message : 'Unknown error',
        updatedAt: new Date().toISOString(),
      })
      .where(eq(prSuggestions.id, suggestionId))

    throw error
  }
}

/**
 * Reject PR suggestion
 */
export async function rejectPRSuggestion(
  suggestionId: string,
  userId: string
): Promise<void> {
  await db
    .update(prSuggestions)
    .set({
      status: 'REJECTED',
      reviewedBy: userId,
      reviewedAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    })
    .where(eq(prSuggestions.id, suggestionId))

  await logActivity({
    actorId: userId,
    actorRole: 'ADMIN',
    verb: 'PR_SUGGESTION_REJECTED',
    summary: 'Rejected PR suggestion',
    targetType: 'PROJECT',
    targetId: suggestionId,
  })
}
```

### 2. Create `/app/api/pr-suggestions/route.ts`

```typescript
import { NextResponse } from 'next/server'
import { requireRole } from '@/lib/auth/session'
import { getPendingPRSuggestions } from '@/lib/data/pr-suggestions'

export async function GET() {
  await requireRole('ADMIN')

  const suggestions = await getPendingPRSuggestions()

  return NextResponse.json({ suggestions })
}
```

### 3. Create `/app/api/pr-suggestions/[suggestionId]/approve/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { z } from 'zod'
import { requireRole } from '@/lib/auth/session'
import { approvePRSuggestion } from '@/lib/data/pr-suggestions'

const schema = z.object({
  title: z.string().min(1).max(100).optional(),
  body: z.string().max(10000).optional(),
  branch: z.string().max(100).optional(),
  baseBranch: z.string().max(100).optional(),
})

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ suggestionId: string }> }
) {
  const user = await requireRole('ADMIN')
  const { suggestionId } = await params

  const body = await request.json().catch(() => ({}))
  const modifications = schema.parse(body)

  try {
    const result = await approvePRSuggestion(
      suggestionId,
      user.id,
      Object.keys(modifications).length > 0 ? modifications : undefined
    )

    return NextResponse.json({
      success: true,
      prNumber: result.prNumber,
      prUrl: result.prUrl,
    })
  } catch (error) {
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'Failed to create PR' },
      { status: 400 }
    )
  }
}
```

### 4. Create `/app/api/pr-suggestions/[suggestionId]/reject/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireRole } from '@/lib/auth/session'
import { rejectPRSuggestion } from '@/lib/data/pr-suggestions'

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ suggestionId: string }> }
) {
  const user = await requireRole('ADMIN')
  const { suggestionId } = await params

  try {
    await rejectPRSuggestion(suggestionId, user.id)
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to reject' }, { status: 400 })
  }
}
```

### 5. Create `/app/(dashboard)/pr-suggestions/page.tsx`

```typescript
import { requireRole } from '@/lib/auth/session'
import { getPendingPRSuggestions } from '@/lib/data/pr-suggestions'
import { PRSuggestionsPanel } from './_components/pr-suggestions-panel'

export default async function PRSuggestionsPage() {
  await requireRole('ADMIN')

  const suggestions = await getPendingPRSuggestions()

  return (
    <div className='space-y-6'>
      <div>
        <h1 className='text-2xl font-semibold'>PR Suggestions</h1>
        <p className='text-muted-foreground'>
          Review and create GitHub pull requests from AI suggestions.
        </p>
      </div>
      <PRSuggestionsPanel initialSuggestions={suggestions} />
    </div>
  )
}
```

### 6. Create `/app/(dashboard)/pr-suggestions/_components/pr-suggestions-panel.tsx`

```typescript
'use client'

import { useState } from 'react'
import { Github, GitPullRequest, ExternalLink } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { useToast } from '@/components/ui/use-toast'
import type { PRSuggestionWithContext } from '@/lib/types/github'
import { PREditSheet } from './pr-edit-sheet'

interface PRSuggestionsPanelProps {
  initialSuggestions: PRSuggestionWithContext[]
}

export function PRSuggestionsPanel({ initialSuggestions }: PRSuggestionsPanelProps) {
  const { toast } = useToast()
  const [suggestions, setSuggestions] = useState(initialSuggestions)
  const [editingSuggestion, setEditingSuggestion] = useState<PRSuggestionWithContext | null>(null)

  const handleReject = async (suggestionId: string) => {
    try {
      await fetch(`/api/pr-suggestions/${suggestionId}/reject`, { method: 'POST' })
      setSuggestions(prev => prev.filter(s => s.id !== suggestionId))
      toast({ title: 'PR suggestion rejected' })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to reject', variant: 'destructive' })
    }
  }

  const handleApproved = (suggestionId: string, prUrl: string) => {
    setSuggestions(prev => prev.filter(s => s.id !== suggestionId))
    toast({
      title: 'PR Created!',
      description: (
        <a href={prUrl} target='_blank' rel='noopener noreferrer' className='underline'>
          View on GitHub <ExternalLink className='inline h-3 w-3' />
        </a>
      ),
    })
    setEditingSuggestion(null)
  }

  if (suggestions.length === 0) {
    return (
      <div className='rounded-lg border border-dashed p-8 text-center'>
        <GitPullRequest className='mx-auto h-8 w-8 text-muted-foreground' />
        <p className='mt-2 text-sm text-muted-foreground'>
          No pending PR suggestions. Generate PR suggestions from emails or tasks.
        </p>
      </div>
    )
  }

  return (
    <div className='space-y-4'>
      {suggestions.map(suggestion => (
        <Card key={suggestion.id}>
          <CardHeader className='pb-2'>
            <div className='flex items-start justify-between'>
              <div className='space-y-1'>
                <CardTitle className='text-base'>{suggestion.suggestedTitle}</CardTitle>
                <div className='flex items-center gap-2 text-sm text-muted-foreground'>
                  <Github className='h-4 w-4' />
                  <span>{suggestion.repoLink.repoFullName}</span>
                  <span>â†’</span>
                  <Badge variant='outline'>{suggestion.suggestedBaseBranch}</Badge>
                </div>
              </div>
              <Badge
                variant='outline'
                className={
                  Number(suggestion.confidence) >= 0.8 ? 'text-green-600' :
                  Number(suggestion.confidence) >= 0.6 ? 'text-amber-600' : 'text-red-600'
                }
              >
                {Math.round(Number(suggestion.confidence) * 100)}%
              </Badge>
            </div>
          </CardHeader>
          <CardContent>
            {suggestion.email && (
              <p className='text-sm text-muted-foreground mb-2'>
                From email: "{suggestion.email.subject}"
              </p>
            )}

            {suggestion.suggestedBranch && (
              <p className='text-sm mb-2'>
                <span className='text-muted-foreground'>Branch:</span>{' '}
                <code className='bg-muted px-1 rounded'>{suggestion.suggestedBranch}</code>
              </p>
            )}

            <div className='bg-muted rounded-md p-3 mb-4 max-h-40 overflow-auto'>
              <pre className='text-xs whitespace-pre-wrap'>{suggestion.suggestedBody}</pre>
            </div>

            {suggestion.reasoning && (
              <p className='text-xs text-muted-foreground italic mb-4'>
                "{suggestion.reasoning}"
              </p>
            )}

            <div className='flex justify-end gap-2'>
              <Button
                variant='outline'
                size='sm'
                onClick={() => handleReject(suggestion.id)}
              >
                Reject
              </Button>
              <Button size='sm' onClick={() => setEditingSuggestion(suggestion)}>
                Review & Create PR
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}

      <PREditSheet
        suggestion={editingSuggestion}
        onClose={() => setEditingSuggestion(null)}
        onApproved={handleApproved}
      />
    </div>
  )
}
```

### 7. Create `/app/(dashboard)/pr-suggestions/_components/pr-edit-sheet.tsx`

```typescript
'use client'

import { useEffect } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Loader2, Github, ExternalLink } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
  SheetDescription,
} from '@/components/ui/sheet'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from '@/components/ui/form'
import { useToast } from '@/components/ui/use-toast'
import type { PRSuggestionWithContext } from '@/lib/types/github'

const editSchema = z.object({
  title: z.string().min(1, 'Title required').max(100),
  body: z.string().max(10000),
  branch: z.string().min(1, 'Branch name required').max(100),
  baseBranch: z.string().min(1).max(100),
})

type EditFormValues = z.infer<typeof editSchema>

interface PREditSheetProps {
  suggestion: PRSuggestionWithContext | null
  onClose: () => void
  onApproved: (suggestionId: string, prUrl: string) => void
}

export function PREditSheet({ suggestion, onClose, onApproved }: PREditSheetProps) {
  const { toast } = useToast()

  const form = useForm<EditFormValues>({
    resolver: zodResolver(editSchema),
    defaultValues: {
      title: '',
      body: '',
      branch: '',
      baseBranch: 'main',
    },
  })

  useEffect(() => {
    if (suggestion) {
      form.reset({
        title: suggestion.suggestedTitle,
        body: suggestion.suggestedBody,
        branch: suggestion.suggestedBranch || '',
        baseBranch: suggestion.suggestedBaseBranch || 'main',
      })
    }
  }, [suggestion, form])

  const onSubmit = async (values: EditFormValues) => {
    if (!suggestion) return

    try {
      const response = await fetch(`/api/pr-suggestions/${suggestion.id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values),
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || 'Failed to create PR')
      }

      onApproved(suggestion.id, result.prUrl)
    } catch (error) {
      toast({
        title: 'Error',
        description: error instanceof Error ? error.message : 'Failed to create PR',
        variant: 'destructive',
      })
    }
  }

  if (!suggestion) return null

  return (
    <Sheet open={!!suggestion} onOpenChange={() => onClose()}>
      <SheetContent className='w-[600px] sm:max-w-[600px] overflow-y-auto'>
        <SheetHeader>
          <SheetTitle className='flex items-center gap-2'>
            <Github className='h-5 w-5' />
            Create Pull Request
          </SheetTitle>
          <SheetDescription>
            Review and edit before creating the PR on{' '}
            <a
              href={`https://github.com/${suggestion.repoLink.repoFullName}`}
              target='_blank'
              rel='noopener noreferrer'
              className='underline'
            >
              {suggestion.repoLink.repoFullName}
              <ExternalLink className='inline ml-1 h-3 w-3' />
            </a>
          </SheetDescription>
        </SheetHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className='mt-6 space-y-4'>
            <FormField
              control={form.control}
              name='title'
              render={({ field }) => (
                <FormItem>
                  <FormLabel>PR Title</FormLabel>
                  <FormControl>
                    <Input {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className='grid grid-cols-2 gap-4'>
              <FormField
                control={form.control}
                name='branch'
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Head Branch</FormLabel>
                    <FormControl>
                      <Input {...field} placeholder='feature/my-branch' />
                    </FormControl>
                    <FormDescription>Branch with your changes</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name='baseBranch'
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Base Branch</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormDescription>Branch to merge into</FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name='body'
              render={({ field }) => (
                <FormItem>
                  <FormLabel>PR Description</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={12} className='font-mono text-sm' />
                  </FormControl>
                  <FormDescription>Markdown supported</FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className='flex justify-end gap-2 pt-4'>
              <Button type='button' variant='outline' onClick={onClose}>
                Cancel
              </Button>
              <Button type='submit' disabled={form.formState.isSubmitting}>
                {form.formState.isSubmitting ? (
                  <>
                    <Loader2 className='mr-2 h-4 w-4 animate-spin' />
                    Creating PR...
                  </>
                ) : (
                  'Create Pull Request'
                )}
              </Button>
            </div>
          </form>
        </Form>
      </SheetContent>
    </Sheet>
  )
}
```

### 8. Add navigation link

Add "PR Suggestions" link to sidebar for admin users.

## Acceptance Criteria

- [ ] List pending PR suggestions
- [ ] Show repo, branch, confidence
- [ ] Edit sheet for review/modifications
- [ ] Create PR on GitHub on approve
- [ ] Show PR URL after creation
- [ ] Reject removes suggestion
- [ ] Error handling for PR creation failures
- [ ] Activity logged
- [ ] Navigation link added

## Files Changed
- `lib/data/pr-suggestions/index.ts` (new)
- `app/api/pr-suggestions/route.ts` (new)
- `app/api/pr-suggestions/[suggestionId]/approve/route.ts` (new)
- `app/api/pr-suggestions/[suggestionId]/reject/route.ts` (new)
- `app/(dashboard)/pr-suggestions/page.tsx` (new)
- `app/(dashboard)/pr-suggestions/_components/pr-suggestions-panel.tsx` (new)
- `app/(dashboard)/pr-suggestions/_components/pr-edit-sheet.tsx` (new)
- Navigation component (modified)

## Testing

1. Generate a PR suggestion from an email
2. View suggestions list
3. Click "Review & Create PR"
4. Edit title/description/branch
5. Click "Create Pull Request"
6. Verify PR created on GitHub
7. Check activity log

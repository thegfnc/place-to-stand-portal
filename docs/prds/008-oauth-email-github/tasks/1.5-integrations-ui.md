# Task 1.5: Integrations UI

## Overview
Update the integrations settings page to show real connection status and enable connect/disconnect functionality for Google.

## Dependencies
- Task 1.3 (Google OAuth Flow)

## Design System Reference

Follow existing patterns from the codebase:
- Use `Button` from `@/components/ui/button`
- Use `Card`, `CardHeader`, `CardTitle`, `CardDescription`, `CardContent` from `@/components/ui/card`
- Use `useToast` from `@/components/ui/use-toast` for notifications
- Use `Loader2` from `lucide-react` for loading states
- Use `Badge` from `@/components/ui/badge` for status indicators

## Deliverables

### 1. Create `/lib/data/integrations/index.ts`

```typescript
import { eq, and, isNull } from 'drizzle-orm'
import { db } from '@/lib/db'
import { oauthConnections } from '@/lib/db/schema'

export type OAuthProvider = 'GOOGLE' | 'GITHUB'

export interface IntegrationStatus {
  connected: boolean
  status?: 'ACTIVE' | 'EXPIRED' | 'REVOKED' | 'PENDING_REAUTH'
  email?: string
  connectedAt?: string
  lastSyncAt?: string
}

export async function getIntegrationStatus(
  userId: string,
  provider: OAuthProvider
): Promise<IntegrationStatus> {
  const [connection] = await db
    .select({
      status: oauthConnections.status,
      providerEmail: oauthConnections.providerEmail,
      createdAt: oauthConnections.createdAt,
      lastSyncAt: oauthConnections.lastSyncAt,
    })
    .from(oauthConnections)
    .where(
      and(
        eq(oauthConnections.userId, userId),
        eq(oauthConnections.provider, provider),
        isNull(oauthConnections.deletedAt)
      )
    )
    .limit(1)

  if (!connection) {
    return { connected: false }
  }

  return {
    connected: true,
    status: connection.status,
    email: connection.providerEmail ?? undefined,
    connectedAt: connection.createdAt,
    lastSyncAt: connection.lastSyncAt ?? undefined,
  }
}

export async function getAllIntegrationStatuses(userId: string): Promise<{
  google: IntegrationStatus
  github: IntegrationStatus
}> {
  const [google, github] = await Promise.all([
    getIntegrationStatus(userId, 'GOOGLE'),
    getIntegrationStatus(userId, 'GITHUB'),
  ])

  return { google, github }
}
```

### 2. Update `/app/(dashboard)/settings/integrations/page.tsx`

```typescript
import { requireUser } from '@/lib/auth/session'
import { getAllIntegrationStatuses } from '@/lib/data/integrations'
import { IntegrationsPanel } from './integrations-panel'

export default async function IntegrationsPage() {
  const user = await requireUser()
  const integrations = await getAllIntegrationStatuses(user.id)

  return (
    <div className='space-y-6'>
      <div>
        <h1 className='text-2xl font-semibold'>Integrations</h1>
        <p className='text-muted-foreground'>
          Connect external services to enhance your workflow.
        </p>
      </div>
      <IntegrationsPanel integrations={integrations} />
    </div>
  )
}
```

### 3. Replace `/app/(dashboard)/settings/integrations/integrations-panel.tsx`

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { siGithub } from 'simple-icons/icons'
import { Loader2, CheckCircle2, AlertCircle, ExternalLink } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { useToast } from '@/components/ui/use-toast'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'
import type { IntegrationStatus } from '@/lib/data/integrations'

function SimpleIcon({
  icon,
  className,
}: {
  icon: { title: string; path: string }
  className?: string
}) {
  return (
    <svg
      role='img'
      viewBox='0 0 24 24'
      className={className}
      xmlns='http://www.w3.org/2000/svg'
      fill='currentColor'
    >
      <title>{icon.title}</title>
      <path d={icon.path} />
    </svg>
  )
}

function GoogleIcon({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
      <path
        d='M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z'
        fill='#4285F4'
      />
      <path
        d='M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z'
        fill='#34A853'
      />
      <path
        d='M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.26.81-.58z'
        fill='#FBBC05'
      />
      <path
        d='M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z'
        fill='#EA4335'
      />
    </svg>
  )
}

interface IntegrationsPanelProps {
  integrations: {
    google: IntegrationStatus
    github: IntegrationStatus
  }
}

export function IntegrationsPanel({ integrations }: IntegrationsPanelProps) {
  const router = useRouter()
  const { toast } = useToast()
  const [disconnecting, setDisconnecting] = useState<'google' | 'github' | null>(null)

  const handleGoogleConnect = () => {
    // Redirect to OAuth flow
    window.location.href = '/api/auth/google'
  }

  const handleGoogleDisconnect = async () => {
    setDisconnecting('google')
    try {
      const response = await fetch('/api/integrations/google/disconnect', {
        method: 'POST',
      })

      if (!response.ok) {
        throw new Error('Failed to disconnect')
      }

      toast({
        title: 'Disconnected',
        description: 'Google account has been disconnected.',
      })

      router.refresh()
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to disconnect Google account.',
        variant: 'destructive',
      })
    } finally {
      setDisconnecting(null)
    }
  }

  const getStatusBadge = (status: IntegrationStatus) => {
    if (!status.connected) return null

    switch (status.status) {
      case 'ACTIVE':
        return (
          <Badge variant='outline' className='text-green-600 border-green-600'>
            <CheckCircle2 className='mr-1 h-3 w-3' />
            Connected
          </Badge>
        )
      case 'PENDING_REAUTH':
        return (
          <Badge variant='outline' className='text-amber-600 border-amber-600'>
            <AlertCircle className='mr-1 h-3 w-3' />
            Reconnect Required
          </Badge>
        )
      case 'EXPIRED':
      case 'REVOKED':
        return (
          <Badge variant='outline' className='text-red-600 border-red-600'>
            <AlertCircle className='mr-1 h-3 w-3' />
            {status.status === 'EXPIRED' ? 'Expired' : 'Revoked'}
          </Badge>
        )
      default:
        return null
    }
  }

  const formatDate = (dateStr?: string) => {
    if (!dateStr) return null
    return new Date(dateStr).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    })
  }

  return (
    <div className='grid gap-6'>
      {/* Google Workspace */}
      <Card>
        <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
          <div className='flex flex-col space-y-1.5'>
            <div className='flex items-center gap-3'>
              <CardTitle className='flex items-center gap-2'>
                <GoogleIcon className='h-5 w-5' />
                Google Workspace
              </CardTitle>
              {getStatusBadge(integrations.google)}
            </div>
            <CardDescription>
              {integrations.google.connected && integrations.google.email ? (
                <>Connected as {integrations.google.email}</>
              ) : (
                <>Connect your Google account to sync emails and access Gmail.</>
              )}
            </CardDescription>
          </div>
        </CardHeader>
        <CardContent className='space-y-4'>
          {integrations.google.connected && (
            <div className='text-sm text-muted-foreground'>
              {integrations.google.connectedAt && (
                <p>Connected on {formatDate(integrations.google.connectedAt)}</p>
              )}
              {integrations.google.lastSyncAt && (
                <p>Last synced {formatDate(integrations.google.lastSyncAt)}</p>
              )}
            </div>
          )}

          <div className='flex gap-2'>
            {integrations.google.connected ? (
              <>
                {integrations.google.status === 'PENDING_REAUTH' && (
                  <Button variant='default' onClick={handleGoogleConnect}>
                    Reconnect
                  </Button>
                )}
                <Button
                  variant='outline'
                  onClick={handleGoogleDisconnect}
                  disabled={disconnecting === 'google'}
                >
                  {disconnecting === 'google' ? (
                    <>
                      <Loader2 className='mr-2 h-4 w-4 animate-spin' />
                      Disconnecting...
                    </>
                  ) : (
                    'Disconnect'
                  )}
                </Button>
              </>
            ) : (
              <Button variant='default' onClick={handleGoogleConnect}>
                Connect Google Account
              </Button>
            )}
          </div>
        </CardContent>
      </Card>

      {/* GitHub - Coming Soon */}
      <Card>
        <CardHeader className='flex flex-row items-center justify-between space-y-0 pb-2'>
          <div className='flex flex-col space-y-1.5'>
            <div className='flex items-center gap-3'>
              <CardTitle className='flex items-center gap-2'>
                <SimpleIcon icon={siGithub} className='h-5 w-5' />
                GitHub
              </CardTitle>
              {getStatusBadge(integrations.github)}
            </div>
            <CardDescription>
              {integrations.github.connected && integrations.github.email ? (
                <>Connected as {integrations.github.email}</>
              ) : (
                <>Connect your GitHub account to link repositories and create PRs.</>
              )}
            </CardDescription>
          </div>
        </CardHeader>
        <CardContent>
          <TooltipProvider>
            <Tooltip>
              <TooltipTrigger asChild>
                <span>
                  <Button variant='outline' disabled>
                    Connect GitHub Account
                  </Button>
                </span>
              </TooltipTrigger>
              <TooltipContent>
                <p>Coming in Phase 4</p>
              </TooltipContent>
            </Tooltip>
          </TooltipProvider>
        </CardContent>
      </Card>
    </div>
  )
}
```

### 4. Handle URL query params for success/error messages

Update the page to read query params and show toasts:

```typescript
// Add to integrations-panel.tsx
'use client'

import { useEffect } from 'react'
import { useSearchParams } from 'next/navigation'

// Inside the component:
const searchParams = useSearchParams()

useEffect(() => {
  const success = searchParams.get('success')
  const error = searchParams.get('error')

  if (success === 'google_connected') {
    toast({
      title: 'Connected!',
      description: 'Your Google account has been connected successfully.',
    })
    // Clean URL
    window.history.replaceState({}, '', '/settings/integrations')
  }

  if (error) {
    const errorMessages: Record<string, string> = {
      access_denied: 'You denied access to your Google account.',
      invalid_request: 'Invalid OAuth request. Please try again.',
      invalid_state: 'Security validation failed. Please try again.',
      oauth_failed: 'Failed to connect Google account. Please try again.',
    }
    toast({
      title: 'Connection Failed',
      description: errorMessages[error] || 'An error occurred.',
      variant: 'destructive',
    })
    window.history.replaceState({}, '', '/settings/integrations')
  }
}, [searchParams, toast])
```

## Acceptance Criteria

- [ ] Google card shows "Connected" badge when connected
- [ ] Shows connected email address
- [ ] Shows connected/last sync dates
- [ ] Connect button initiates OAuth flow
- [ ] Disconnect button removes connection with loading state
- [ ] Success toast shown after OAuth callback
- [ ] Error toast shown for OAuth failures
- [ ] Reconnect button shown when status is PENDING_REAUTH
- [ ] GitHub card still shows "Coming Soon" tooltip
- [ ] Page uses server-side data fetching

## Files Changed
- `lib/data/integrations/index.ts` (new)
- `app/(dashboard)/settings/integrations/page.tsx` (modified)
- `app/(dashboard)/settings/integrations/integrations-panel.tsx` (replaced)

## Testing

1. Visit `/settings/integrations` - should see Google card with "Connect" button
2. Click connect - should redirect to Google OAuth
3. After auth - should return to page with success toast
4. Card should show "Connected" with email
5. Click disconnect - should remove connection with toast
6. Test error cases by denying OAuth access

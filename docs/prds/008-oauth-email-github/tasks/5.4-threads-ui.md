# Task 5.4: Threads UI (Client Detail + Composer)

## Overview

Expose threads in the UI under each client, with the ability to view and append messages of different types. Support AI-generated thread titles and composing replies (email/chat) from within the portal.

## Dependencies

- 5.1 (Threads and Messages Schema)
- 5.2 (Message Ingestion API)

## Deliverables

1) Client detail – Threads tab

- Add a new "Threads" tab to `/clients/[clientId]` using shadcn tabs.
- List threads with: title (or placeholder), last activity timestamp, message count, status.
- Filters: status (open/archived), search by title/content (client-side to start), and an "Unassigned" scope showing `clientId = null` threads in a Triage view.
- Empty/Loading/Error states: shadcn skeletons and helpful messages.

2) Thread view

- Paginated message list ordered by `created_at` asc.
- Per-message rendering by `type`:
  - `email`: subject/from/to/date with normalized snippet
  - `chat`: author, timestamp, text
  - `voice_memo`: filename/duration with playback control (stub)
  - `document`: filename/type with link (stub)
  - `form`/`transcript`: label plus structured body_json preview

3) Composer

- Generic composer with a `type` selector (start with `chat` and `email`), body editor (RTE for chat, plain for email), and submit via `POST /api/v1/messages/ingest`.
- If unlinked, require selecting a `client` and optionally an existing `thread`.
- Tooltips on disabled states explaining required fields.

4) Triage linking

- In Triage (unassigned), provide a "Link to client" action to set `clientId` on the thread and create identity links (see 5.6) for discovered email addresses so future messages auto-link.

5) AI Title

- If a thread has no title, show a small CTA to “Generate title”. Calls background job (or a server action) to set a title using recent messages.

6) AuthZ & error UX

- Gate reads/writes with server-side checks; surface permission errors with actionable UI hints.

## Acceptance Criteria

- Users can view a client’s threads, open one, and append a chat/email message.
- New threads can be created from the UI when posting a first message.
- Disabled buttons include tooltips with a short reason.

## Files Changed

- `app/(dashboard)/clients/[clientId]/threads/page.tsx` (new)
- `app/(dashboard)/clients/[clientId]/threads/[threadId]/page.tsx` (new)
- `components/threads/` (new) – list, item, composer components
- `lib/queries/threads.ts` (new) – query helpers with auth guards

## Notes

- Use server components for data loading where possible; client components for interactivity.
- Defer heavy widgets and media handling to later iterations with `next/dynamic`.

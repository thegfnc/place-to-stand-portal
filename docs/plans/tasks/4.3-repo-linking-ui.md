# Task 4.3: Repository Linking UI

## Overview
Create UI for linking GitHub repositories to projects and managing those links.

## Dependencies
- Task 4.2 (GitHub Repo Schema)

## Deliverables

### 1. Create `/lib/github/client.ts`

```typescript
import { eq, and, isNull } from 'drizzle-orm'
import { db } from '@/lib/db'
import { oauthConnections } from '@/lib/db/schema'
import { decryptToken } from '@/lib/oauth/encryption'

const GITHUB_API_BASE = 'https://api.github.com'

interface GitHubRepo {
  id: number
  name: string
  full_name: string
  owner: { login: string }
  default_branch: string
  private: boolean
  description: string | null
  html_url: string
}

/**
 * Get GitHub access token for user
 */
async function getGitHubToken(userId: string): Promise<string> {
  const [connection] = await db
    .select()
    .from(oauthConnections)
    .where(
      and(
        eq(oauthConnections.userId, userId),
        eq(oauthConnections.provider, 'GITHUB'),
        eq(oauthConnections.status, 'ACTIVE'),
        isNull(oauthConnections.deletedAt)
      )
    )
    .limit(1)

  if (!connection) {
    throw new Error('No active GitHub connection')
  }

  return decryptToken(connection.accessToken)
}

/**
 * Make authenticated GitHub API request
 */
async function githubFetch<T>(
  userId: string,
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const token = await getGitHubToken(userId)

  const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, {
    ...options,
    headers: {
      Authorization: `Bearer ${token}`,
      Accept: 'application/vnd.github.v3+json',
      ...options.headers,
    },
  })

  if (!response.ok) {
    const error = await response.text()
    throw new Error(`GitHub API error (${response.status}): ${error}`)
  }

  return response.json()
}

/**
 * List repositories user has access to
 */
export async function listUserRepos(
  userId: string,
  options: { page?: number; perPage?: number } = {}
): Promise<GitHubRepo[]> {
  const { page = 1, perPage = 100 } = options

  return githubFetch(
    userId,
    `/user/repos?sort=updated&per_page=${perPage}&page=${page}`
  )
}

/**
 * Get single repository details
 */
export async function getRepo(
  userId: string,
  owner: string,
  repo: string
): Promise<GitHubRepo> {
  return githubFetch(userId, `/repos/${owner}/${repo}`)
}

/**
 * Create a pull request
 */
export async function createPullRequest(
  userId: string,
  owner: string,
  repo: string,
  params: {
    title: string
    body: string
    head: string
    base: string
  }
): Promise<{ number: number; html_url: string }> {
  return githubFetch(userId, `/repos/${owner}/${repo}/pulls`, {
    method: 'POST',
    body: JSON.stringify(params),
  })
}

/**
 * Get repository branches
 */
export async function listBranches(
  userId: string,
  owner: string,
  repo: string
): Promise<Array<{ name: string }>> {
  return githubFetch(userId, `/repos/${owner}/${repo}/branches`)
}
```

### 2. Create `/lib/data/github-repos/index.ts`

```typescript
import { eq, and, isNull } from 'drizzle-orm'
import { db } from '@/lib/db'
import { githubRepoLinks, projects } from '@/lib/db/schema'
import { logActivity } from '@/lib/activity/logger'
import type { GitHubRepoLink, GitHubRepoLinkWithProject } from '@/lib/types/github'

/**
 * Get repos linked to a project
 */
export async function getProjectRepos(projectId: string): Promise<GitHubRepoLink[]> {
  return db
    .select()
    .from(githubRepoLinks)
    .where(
      and(
        eq(githubRepoLinks.projectId, projectId),
        isNull(githubRepoLinks.deletedAt)
      )
    )
}

/**
 * Link a repository to a project
 */
export async function linkRepoToProject(
  projectId: string,
  repo: {
    repoOwner: string
    repoName: string
    repoFullName: string
    repoId: number
    defaultBranch: string
  },
  userId: string
): Promise<GitHubRepoLink> {
  const [link] = await db
    .insert(githubRepoLinks)
    .values({
      projectId,
      repoOwner: repo.repoOwner,
      repoName: repo.repoName,
      repoFullName: repo.repoFullName,
      repoId: repo.repoId,
      defaultBranch: repo.defaultBranch,
      linkedBy: userId,
    })
    .returning()

  await logActivity({
    actorId: userId,
    actorRole: 'ADMIN',
    verb: 'GITHUB_REPO_LINKED',
    summary: `Linked repository ${repo.repoFullName} to project`,
    targetType: 'PROJECT',
    targetId: projectId,
    targetProjectId: projectId,
    metadata: { repoFullName: repo.repoFullName },
  })

  return link
}

/**
 * Unlink a repository from a project
 */
export async function unlinkRepo(linkId: string, userId: string): Promise<void> {
  const [link] = await db
    .select()
    .from(githubRepoLinks)
    .where(eq(githubRepoLinks.id, linkId))
    .limit(1)

  if (!link) throw new Error('Link not found')

  await db
    .update(githubRepoLinks)
    .set({
      deletedAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    })
    .where(eq(githubRepoLinks.id, linkId))

  await logActivity({
    actorId: userId,
    actorRole: 'ADMIN',
    verb: 'GITHUB_REPO_UNLINKED',
    summary: `Unlinked repository ${link.repoFullName}`,
    targetType: 'PROJECT',
    targetId: link.projectId,
    targetProjectId: link.projectId,
    metadata: { repoFullName: link.repoFullName },
  })
}
```

### 3. Create `/app/api/integrations/github/repos/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireRole } from '@/lib/auth/session'
import { listUserRepos } from '@/lib/github/client'

export async function GET(request: NextRequest) {
  const user = await requireRole('ADMIN')

  try {
    const repos = await listUserRepos(user.id)

    return NextResponse.json({
      repos: repos.map(r => ({
        id: r.id,
        name: r.name,
        fullName: r.full_name,
        owner: r.owner.login,
        defaultBranch: r.default_branch,
        private: r.private,
        description: r.description,
        url: r.html_url,
      })),
    })
  } catch (error) {
    if (error instanceof Error && error.message.includes('No active GitHub')) {
      return NextResponse.json(
        { error: 'GitHub not connected', code: 'NOT_CONNECTED' },
        { status: 401 }
      )
    }
    return NextResponse.json({ error: 'Failed to fetch repos' }, { status: 500 })
  }
}
```

### 4. Create `/app/api/projects/[projectId]/github-repos/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { z } from 'zod'
import { requireRole } from '@/lib/auth/session'
import { getProjectRepos, linkRepoToProject } from '@/lib/data/github-repos'
import { getRepo } from '@/lib/github/client'

const linkSchema = z.object({
  repoFullName: z.string().regex(/^[^/]+\/[^/]+$/, 'Invalid repo format'),
})

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ projectId: string }> }
) {
  await requireRole('ADMIN')
  const { projectId } = await params

  const repos = await getProjectRepos(projectId)

  return NextResponse.json({ repos })
}

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ projectId: string }> }
) {
  const user = await requireRole('ADMIN')
  const { projectId } = await params

  const body = await request.json()
  const result = linkSchema.safeParse(body)

  if (!result.success) {
    return NextResponse.json({ error: 'Invalid repo format' }, { status: 400 })
  }

  const [owner, name] = result.data.repoFullName.split('/')

  try {
    // Verify repo exists and get details
    const repoDetails = await getRepo(user.id, owner, name)

    const link = await linkRepoToProject(
      projectId,
      {
        repoOwner: repoDetails.owner.login,
        repoName: repoDetails.name,
        repoFullName: repoDetails.full_name,
        repoId: repoDetails.id,
        defaultBranch: repoDetails.default_branch,
      },
      user.id
    )

    return NextResponse.json({ success: true, link })
  } catch (error) {
    if (error instanceof Error && error.message.includes('unique')) {
      return NextResponse.json(
        { error: 'Repo already linked to this project' },
        { status: 400 }
      )
    }
    return NextResponse.json({ error: 'Failed to link repo' }, { status: 500 })
  }
}
```

### 5. Create `/app/api/projects/[projectId]/github-repos/[linkId]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireRole } from '@/lib/auth/session'
import { unlinkRepo } from '@/lib/data/github-repos'

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ projectId: string; linkId: string }> }
) {
  const user = await requireRole('ADMIN')
  const { linkId } = await params

  try {
    await unlinkRepo(linkId, user.id)
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json({ error: 'Failed to unlink repo' }, { status: 500 })
  }
}
```

### 6. Create `/app/(dashboard)/projects/[projectId]/_components/github-repos-section.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import { Plus, Github, Trash2, ExternalLink } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { SearchableCombobox } from '@/components/ui/searchable-combobox'
import { ConfirmDialog } from '@/components/ui/confirm-dialog'
import { useToast } from '@/components/ui/use-toast'
import type { GitHubRepoLink } from '@/lib/types/github'

interface GitHubReposSectionProps {
  projectId: string
  initialRepos: GitHubRepoLink[]
  isGitHubConnected: boolean
}

export function GitHubReposSection({
  projectId,
  initialRepos,
  isGitHubConnected,
}: GitHubReposSectionProps) {
  const { toast } = useToast()
  const [repos, setRepos] = useState(initialRepos)
  const [dialogOpen, setDialogOpen] = useState(false)
  const [availableRepos, setAvailableRepos] = useState<Array<{ value: string; label: string }>>([])
  const [selectedRepo, setSelectedRepo] = useState<string | null>(null)
  const [linking, setLinking] = useState(false)
  const [deleteConfirm, setDeleteConfirm] = useState<GitHubRepoLink | null>(null)

  useEffect(() => {
    if (dialogOpen && isGitHubConnected) {
      fetch('/api/integrations/github/repos')
        .then(r => r.json())
        .then(data => {
          if (data.repos) {
            const linkedFullNames = repos.map(r => r.repoFullName)
            setAvailableRepos(
              data.repos
                .filter((r: any) => !linkedFullNames.includes(r.fullName))
                .map((r: any) => ({
                  value: r.fullName,
                  label: r.fullName,
                  description: r.description || undefined,
                }))
            )
          }
        })
        .catch(() => {
          toast({ title: 'Error', description: 'Failed to load repos', variant: 'destructive' })
        })
    }
  }, [dialogOpen, isGitHubConnected, repos, toast])

  const handleLink = async () => {
    if (!selectedRepo) return

    setLinking(true)
    try {
      const response = await fetch(`/api/projects/${projectId}/github-repos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ repoFullName: selectedRepo }),
      })

      if (!response.ok) throw new Error('Failed to link')

      const data = await response.json()
      setRepos(prev => [...prev, data.link])
      setDialogOpen(false)
      setSelectedRepo(null)

      toast({ title: 'Repository linked', description: `${selectedRepo} is now linked.` })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to link repository', variant: 'destructive' })
    } finally {
      setLinking(false)
    }
  }

  const handleUnlink = async () => {
    if (!deleteConfirm) return

    try {
      await fetch(`/api/projects/${projectId}/github-repos/${deleteConfirm.id}`, {
        method: 'DELETE',
      })

      setRepos(prev => prev.filter(r => r.id !== deleteConfirm.id))
      toast({ title: 'Repository unlinked' })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to unlink', variant: 'destructive' })
    } finally {
      setDeleteConfirm(null)
    }
  }

  if (!isGitHubConnected) {
    return (
      <div className='rounded-lg border border-dashed p-6 text-center'>
        <Github className='mx-auto h-8 w-8 text-muted-foreground' />
        <p className='mt-2 text-sm text-muted-foreground'>
          Connect your GitHub account in Settings to link repositories.
        </p>
        <Button variant='outline' size='sm' className='mt-4' asChild>
          <a href='/settings/integrations'>Go to Settings</a>
        </Button>
      </div>
    )
  }

  return (
    <div className='space-y-4'>
      <div className='flex items-center justify-between'>
        <div>
          <h3 className='text-lg font-medium'>GitHub Repositories</h3>
          <p className='text-sm text-muted-foreground'>
            Linked repositories for PR creation.
          </p>
        </div>
        <Button size='sm' onClick={() => setDialogOpen(true)}>
          <Plus className='mr-2 h-4 w-4' />
          Link Repository
        </Button>
      </div>

      {repos.length === 0 ? (
        <div className='rounded-lg border border-dashed p-6 text-center'>
          <Github className='mx-auto h-8 w-8 text-muted-foreground' />
          <p className='mt-2 text-sm text-muted-foreground'>
            No repositories linked. Link a repo to enable PR suggestions.
          </p>
        </div>
      ) : (
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Repository</TableHead>
              <TableHead>Default Branch</TableHead>
              <TableHead className='w-24'>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {repos.map(repo => (
              <TableRow key={repo.id}>
                <TableCell>
                  <div className='flex items-center gap-2'>
                    <Github className='h-4 w-4' />
                    <a
                      href={`https://github.com/${repo.repoFullName}`}
                      target='_blank'
                      rel='noopener noreferrer'
                      className='hover:underline'
                    >
                      {repo.repoFullName}
                      <ExternalLink className='ml-1 inline h-3 w-3' />
                    </a>
                  </div>
                </TableCell>
                <TableCell>
                  <Badge variant='outline'>{repo.defaultBranch}</Badge>
                </TableCell>
                <TableCell>
                  <Button
                    variant='ghost'
                    size='icon-sm'
                    onClick={() => setDeleteConfirm(repo)}
                  >
                    <Trash2 className='h-4 w-4' />
                  </Button>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      )}

      {/* Link Dialog */}
      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Link GitHub Repository</DialogTitle>
          </DialogHeader>
          <div className='space-y-4 pt-4'>
            <SearchableCombobox
              items={availableRepos}
              value={selectedRepo}
              onChange={setSelectedRepo}
              placeholder='Search repositories...'
              emptyMessage='No repositories found'
            />
            <div className='flex justify-end gap-2'>
              <Button variant='outline' onClick={() => setDialogOpen(false)}>
                Cancel
              </Button>
              <Button onClick={handleLink} disabled={!selectedRepo || linking}>
                {linking ? 'Linking...' : 'Link Repository'}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Unlink Confirmation */}
      <ConfirmDialog
        open={!!deleteConfirm}
        title='Unlink repository?'
        description={`Are you sure you want to unlink ${deleteConfirm?.repoFullName}?`}
        confirmLabel='Unlink'
        cancelLabel='Cancel'
        confirmVariant='destructive'
        onConfirm={handleUnlink}
        onCancel={() => setDeleteConfirm(null)}
      />
    </div>
  )
}
```

### 7. Add activity verbs to `/lib/activity/logger.ts`

```typescript
'GITHUB_REPO_LINKED'
'GITHUB_REPO_UNLINKED'
```

## Acceptance Criteria

- [ ] Can list user's GitHub repos
- [ ] Can link repo to project
- [ ] Can unlink repo from project
- [ ] Shows message when GitHub not connected
- [ ] Searchable repo selector
- [ ] Prevents duplicate links
- [ ] Activity logged for link/unlink
- [ ] External links to GitHub repos

## Files Changed
- `lib/github/client.ts` (new)
- `lib/data/github-repos/index.ts` (new)
- `app/api/integrations/github/repos/route.ts` (new)
- `app/api/projects/[projectId]/github-repos/route.ts` (new)
- `app/api/projects/[projectId]/github-repos/[linkId]/route.ts` (new)
- `app/(dashboard)/projects/[projectId]/_components/github-repos-section.tsx` (new)
- `lib/activity/logger.ts` (modified)
- Project detail page (modified - add section)

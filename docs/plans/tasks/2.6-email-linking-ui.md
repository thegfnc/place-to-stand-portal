# Task 2.6: Email Linking UI

## Overview
Create the UI for viewing synced emails and manually linking them to clients/projects.

## Dependencies
- Task 2.4 (Email Sync Service)
- Task 2.5 (Email Matcher)

## Design System Reference

Use existing patterns:
- Table for email list
- Sheet for email detail view
- SearchableCombobox for client/project selection
- Badge for link status
- Toast for notifications

## Deliverables

### 1. Create `/app/(dashboard)/emails/page.tsx`

```typescript
import { requireRole } from '@/lib/auth/session'
import { getEmailsForUser } from '@/lib/data/emails'
import { getEmailSyncStatus } from '@/lib/email/sync'
import { EmailsPanel } from './_components/emails-panel'

export default async function EmailsPage() {
  const user = await requireRole('ADMIN')
  const [emails, syncStatus] = await Promise.all([
    getEmailsForUser(user.id, { limit: 50 }),
    getEmailSyncStatus(user.id),
  ])

  return (
    <div className='space-y-6'>
      <div>
        <h1 className='text-2xl font-semibold'>Emails</h1>
        <p className='text-muted-foreground'>
          View and link synced emails to clients and projects.
        </p>
      </div>
      <EmailsPanel
        initialEmails={emails}
        syncStatus={syncStatus}
        userId={user.id}
      />
    </div>
  )
}
```

### 2. Create `/app/(dashboard)/emails/_components/emails-panel.tsx`

```typescript
'use client'

import { useState } from 'react'
import { RefreshCw, Mail, Link2, Filter } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { useToast } from '@/components/ui/use-toast'
import type { EmailWithLinks } from '@/lib/types/emails'
import { EmailDetailSheet } from './email-detail-sheet'
import { formatDistanceToNow } from 'date-fns'

interface EmailsPanelProps {
  initialEmails: EmailWithLinks[]
  syncStatus: {
    totalEmails: number
    lastSyncAt: string | null
  }
  userId: string
}

export function EmailsPanel({ initialEmails, syncStatus, userId }: EmailsPanelProps) {
  const { toast } = useToast()
  const [emails, setEmails] = useState(initialEmails)
  const [syncing, setSyncing] = useState(false)
  const [selectedEmail, setSelectedEmail] = useState<EmailWithLinks | null>(null)
  const [filter, setFilter] = useState<'all' | 'linked' | 'unlinked'>('all')

  const handleSync = async () => {
    setSyncing(true)
    try {
      const response = await fetch('/api/integrations/gmail/sync', { method: 'POST' })
      const result = await response.json()

      if (response.ok) {
        toast({
          title: 'Sync complete',
          description: `Synced ${result.synced} new emails.`,
        })
        // Refresh emails
        const emailsResponse = await fetch('/api/emails')
        if (emailsResponse.ok) {
          const data = await emailsResponse.json()
          setEmails(data.emails)
        }
      } else {
        throw new Error(result.error)
      }
    } catch (error) {
      toast({
        title: 'Sync failed',
        description: error instanceof Error ? error.message : 'Unknown error',
        variant: 'destructive',
      })
    } finally {
      setSyncing(false)
    }
  }

  const filteredEmails = emails.filter(email => {
    if (filter === 'linked') return email.links.length > 0
    if (filter === 'unlinked') return email.links.length === 0
    return true
  })

  const handleEmailUpdate = (updatedEmail: EmailWithLinks) => {
    setEmails(prev => prev.map(e => e.id === updatedEmail.id ? updatedEmail : e))
    setSelectedEmail(updatedEmail)
  }

  return (
    <div className='space-y-4'>
      {/* Header */}
      <div className='flex items-center justify-between'>
        <div className='flex items-center gap-4'>
          <Select value={filter} onValueChange={(v: typeof filter) => setFilter(v)}>
            <SelectTrigger className='w-40'>
              <Filter className='mr-2 h-4 w-4' />
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value='all'>All Emails</SelectItem>
              <SelectItem value='linked'>Linked</SelectItem>
              <SelectItem value='unlinked'>Unlinked</SelectItem>
            </SelectContent>
          </Select>
          <span className='text-sm text-muted-foreground'>
            {syncStatus.totalEmails} emails synced
            {syncStatus.lastSyncAt && (
              <> · Last sync {formatDistanceToNow(new Date(syncStatus.lastSyncAt))} ago</>
            )}
          </span>
        </div>
        <Button onClick={handleSync} disabled={syncing} variant='outline'>
          <RefreshCw className={`mr-2 h-4 w-4 ${syncing ? 'animate-spin' : ''}`} />
          {syncing ? 'Syncing...' : 'Sync Now'}
        </Button>
      </div>

      {/* Email Table */}
      {filteredEmails.length === 0 ? (
        <div className='rounded-lg border border-dashed p-8 text-center'>
          <Mail className='mx-auto h-8 w-8 text-muted-foreground' />
          <p className='mt-2 text-sm text-muted-foreground'>
            {filter === 'all'
              ? 'No emails synced yet. Connect Google and sync your inbox.'
              : `No ${filter} emails found.`}
          </p>
        </div>
      ) : (
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className='w-[200px]'>From</TableHead>
              <TableHead>Subject</TableHead>
              <TableHead className='w-[150px]'>Linked To</TableHead>
              <TableHead className='w-[120px]'>Date</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {filteredEmails.map(email => (
              <TableRow
                key={email.id}
                className='cursor-pointer'
                onClick={() => setSelectedEmail(email)}
              >
                <TableCell>
                  <div className='font-medium truncate max-w-[180px]'>
                    {email.fromName || email.fromEmail}
                  </div>
                  {email.fromName && (
                    <div className='text-xs text-muted-foreground truncate max-w-[180px]'>
                      {email.fromEmail}
                    </div>
                  )}
                </TableCell>
                <TableCell>
                  <div className='truncate max-w-[400px]'>
                    {email.subject || '(no subject)'}
                  </div>
                </TableCell>
                <TableCell>
                  {email.links.length > 0 ? (
                    <div className='flex flex-wrap gap-1'>
                      {email.links.slice(0, 2).map(link => (
                        <Badge key={link.id} variant='outline' className='text-xs'>
                          {link.client?.name || link.project?.name}
                        </Badge>
                      ))}
                      {email.links.length > 2 && (
                        <Badge variant='secondary' className='text-xs'>
                          +{email.links.length - 2}
                        </Badge>
                      )}
                    </div>
                  ) : (
                    <span className='text-muted-foreground text-sm'>—</span>
                  )}
                </TableCell>
                <TableCell className='text-sm text-muted-foreground'>
                  {formatDistanceToNow(new Date(email.receivedAt), { addSuffix: true })}
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      )}

      {/* Detail Sheet */}
      <EmailDetailSheet
        email={selectedEmail}
        onClose={() => setSelectedEmail(null)}
        onUpdate={handleEmailUpdate}
      />
    </div>
  )
}
```

### 3. Create `/app/(dashboard)/emails/_components/email-detail-sheet.tsx`

```typescript
'use client'

import { useState, useEffect } from 'react'
import { Link2, X, Building2, FolderKanban, Loader2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { SearchableCombobox } from '@/components/ui/searchable-combobox'
import { useToast } from '@/components/ui/use-toast'
import type { EmailWithLinks } from '@/lib/types/emails'
import { format } from 'date-fns'

interface EmailDetailSheetProps {
  email: EmailWithLinks | null
  onClose: () => void
  onUpdate: (email: EmailWithLinks) => void
}

export function EmailDetailSheet({ email, onClose, onUpdate }: EmailDetailSheetProps) {
  const { toast } = useToast()
  const [clients, setClients] = useState<Array<{ value: string; label: string }>>([])
  const [projects, setProjects] = useState<Array<{ value: string; label: string }>>([])
  const [selectedClient, setSelectedClient] = useState<string | null>(null)
  const [selectedProject, setSelectedProject] = useState<string | null>(null)
  const [linking, setLinking] = useState(false)
  const [suggestions, setSuggestions] = useState<Array<{
    clientId: string
    clientName: string
    confidence: number
  }>>([])

  // Load clients and projects
  useEffect(() => {
    Promise.all([
      fetch('/api/clients').then(r => r.json()),
      fetch('/api/projects').then(r => r.json()),
    ]).then(([clientsData, projectsData]) => {
      setClients(clientsData.map((c: any) => ({ value: c.id, label: c.name })))
      setProjects(projectsData.map((p: any) => ({ value: p.id, label: p.name })))
    })
  }, [])

  // Load suggestions when email changes
  useEffect(() => {
    if (email) {
      fetch(`/api/emails/${email.id}/link`)
        .then(r => r.json())
        .then(data => setSuggestions(data.suggestions || []))
        .catch(() => setSuggestions([]))
    }
  }, [email?.id])

  const handleLink = async (clientId?: string, projectId?: string) => {
    if (!email || (!clientId && !projectId)) return

    setLinking(true)
    try {
      const response = await fetch(`/api/emails/${email.id}/link`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId, projectId }),
      })

      if (!response.ok) throw new Error('Failed to link')

      // Refresh email data
      const updatedResponse = await fetch(`/api/emails/${email.id}`)
      const updatedEmail = await updatedResponse.json()
      onUpdate(updatedEmail)

      toast({ title: 'Email linked', description: 'Successfully linked to client/project.' })
      setSelectedClient(null)
      setSelectedProject(null)
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to link email.', variant: 'destructive' })
    } finally {
      setLinking(false)
    }
  }

  const handleUnlink = async (linkId: string) => {
    if (!email) return

    try {
      await fetch(`/api/emails/links/${linkId}`, { method: 'DELETE' })

      const updatedEmail: EmailWithLinks = {
        ...email,
        links: email.links.filter(l => l.id !== linkId),
      }
      onUpdate(updatedEmail)

      toast({ title: 'Link removed' })
    } catch (error) {
      toast({ title: 'Error', description: 'Failed to remove link.', variant: 'destructive' })
    }
  }

  if (!email) return null

  return (
    <Sheet open={!!email} onOpenChange={() => onClose()}>
      <SheetContent className='w-[500px] sm:max-w-[500px]'>
        <SheetHeader>
          <SheetTitle className='text-lg'>{email.subject || '(no subject)'}</SheetTitle>
        </SheetHeader>

        <div className='mt-6 space-y-6'>
          {/* Email Metadata */}
          <div className='space-y-2 text-sm'>
            <div>
              <span className='text-muted-foreground'>From:</span>{' '}
              <span className='font-medium'>{email.fromName || email.fromEmail}</span>
              {email.fromName && (
                <span className='text-muted-foreground'> ({email.fromEmail})</span>
              )}
            </div>
            <div>
              <span className='text-muted-foreground'>Date:</span>{' '}
              {format(new Date(email.receivedAt), 'PPp')}
            </div>
            {email.snippet && (
              <div className='mt-2 p-3 bg-muted rounded-md text-muted-foreground'>
                {email.snippet}
              </div>
            )}
          </div>

          {/* Current Links */}
          <div>
            <h4 className='font-medium mb-2 flex items-center gap-2'>
              <Link2 className='h-4 w-4' />
              Linked To
            </h4>
            {email.links.length === 0 ? (
              <p className='text-sm text-muted-foreground'>Not linked to any client or project.</p>
            ) : (
              <div className='space-y-2'>
                {email.links.map(link => (
                  <div
                    key={link.id}
                    className='flex items-center justify-between p-2 border rounded-md'
                  >
                    <div className='flex items-center gap-2'>
                      {link.client ? (
                        <Building2 className='h-4 w-4 text-muted-foreground' />
                      ) : (
                        <FolderKanban className='h-4 w-4 text-muted-foreground' />
                      )}
                      <span>{link.client?.name || link.project?.name}</span>
                      <Badge variant='outline' className='text-xs'>
                        {link.source === 'AUTOMATIC'
                          ? `Auto (${Math.round(Number(link.confidence) * 100)}%)`
                          : 'Manual'}
                      </Badge>
                    </div>
                    <Button
                      variant='ghost'
                      size='icon-sm'
                      onClick={() => handleUnlink(link.id)}
                    >
                      <X className='h-4 w-4' />
                    </Button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Suggestions */}
          {suggestions.length > 0 && (
            <div>
              <h4 className='font-medium mb-2'>Suggestions</h4>
              <div className='space-y-2'>
                {suggestions.map(s => (
                  <div
                    key={s.clientId}
                    className='flex items-center justify-between p-2 border rounded-md bg-muted/50'
                  >
                    <div className='flex items-center gap-2'>
                      <Building2 className='h-4 w-4 text-muted-foreground' />
                      <span>{s.clientName}</span>
                      <Badge variant='secondary' className='text-xs'>
                        {Math.round(s.confidence * 100)}% match
                      </Badge>
                    </div>
                    <Button
                      size='sm'
                      variant='outline'
                      onClick={() => handleLink(s.clientId)}
                      disabled={linking}
                    >
                      Link
                    </Button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Manual Link */}
          <div>
            <h4 className='font-medium mb-2'>Add Link</h4>
            <div className='space-y-3'>
              <div className='flex gap-2'>
                <SearchableCombobox
                  items={clients}
                  value={selectedClient}
                  onChange={setSelectedClient}
                  placeholder='Select client...'
                  className='flex-1'
                />
                <Button
                  onClick={() => handleLink(selectedClient || undefined)}
                  disabled={!selectedClient || linking}
                >
                  {linking ? <Loader2 className='h-4 w-4 animate-spin' /> : 'Link'}
                </Button>
              </div>
              <div className='flex gap-2'>
                <SearchableCombobox
                  items={projects}
                  value={selectedProject}
                  onChange={setSelectedProject}
                  placeholder='Select project...'
                  className='flex-1'
                />
                <Button
                  onClick={() => handleLink(undefined, selectedProject || undefined)}
                  disabled={!selectedProject || linking}
                >
                  {linking ? <Loader2 className='h-4 w-4 animate-spin' /> : 'Link'}
                </Button>
              </div>
            </div>
          </div>
        </div>
      </SheetContent>
    </Sheet>
  )
}
```

### 4. Create `/app/api/emails/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireUser } from '@/lib/auth/session'
import { getEmailsForUser } from '@/lib/data/emails'

export async function GET(request: NextRequest) {
  const user = await requireUser()
  const { searchParams } = request.nextUrl

  const limit = parseInt(searchParams.get('limit') || '50', 10)
  const offset = parseInt(searchParams.get('offset') || '0', 10)
  const linkedOnly = searchParams.get('linkedOnly') === 'true'

  const emails = await getEmailsForUser(user.id, { limit, offset, linkedOnly })

  return NextResponse.json({ emails })
}
```

### 5. Create `/app/api/emails/[emailId]/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { requireUser } from '@/lib/auth/session'
import { getEmailById } from '@/lib/data/emails'

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ emailId: string }> }
) {
  const user = await requireUser()
  const { emailId } = await params

  const email = await getEmailById(user.id, emailId)

  if (!email) {
    return NextResponse.json({ error: 'Email not found' }, { status: 404 })
  }

  return NextResponse.json(email)
}
```

### 6. Add navigation link

Update sidebar/navigation to include Emails link for admin users.

## Acceptance Criteria

- [ ] Emails page shows synced emails in table
- [ ] Can filter by all/linked/unlinked
- [ ] Manual sync button works
- [ ] Clicking email opens detail sheet
- [ ] Shows current links with unlink option
- [ ] Shows match suggestions with quick link
- [ ] Can manually link to client or project
- [ ] Toast notifications for all actions
- [ ] Loading states during operations

## Files Changed
- `app/(dashboard)/emails/page.tsx` (new)
- `app/(dashboard)/emails/_components/emails-panel.tsx` (new)
- `app/(dashboard)/emails/_components/email-detail-sheet.tsx` (new)
- `app/api/emails/route.ts` (new)
- `app/api/emails/[emailId]/route.ts` (new)
- Navigation component (modified - add Emails link)

# Task 5.5: Leads → Client Conversion Flow & Project Stages

## Overview

Define the flow to convert a qualified lead into a client and bootstrap initial project(s), aligning stages discussed in the transcript and integrating with threads so communication continues seamlessly after conversion.

## Dependencies

- PRD 007 (Clients & CRM)
- Existing clients/projects/tasks schema

## Deliverables

1) Stages alignment

- Project stage enum update proposal (software agency): `discovery`, `onboarding`, `active`, `on_hold`, `completed`.
- Leads pipeline stages (final): `new`, `qualified`, `discovery`, `proposal_sent`, `negotiation`, `on_ice`, `closed_won`, `closed_lost`.
- Moving a lead to `closed_won` enables a “Convert to Client” CTA.

2) Conversion action

- Server action: given a `leadId`, create `client` (copying contact info), create an initial `project` with stage `discovery` (or selected), and migrate any associated communication threads:
  - If the lead already has threads/messages (e.g., from web form/emails), reassign them to the new client id.
  - Preserve history intact.

3) Linking rules

- When conversion occurs and a primary email is known, create identity links (see 5.6) so future emails auto-associate with the new client.

4) UX

- In Leads board, “Convert to Client” button visible when status is `Closed Won` (or defined threshold). Confirm modal with summary of what will be created.

## Acceptance Criteria

- A lead can be converted into a client with an initial project and existing comms (threads/messages) reassigned.
- Project stages updated as proposed and reflected in UI where stages display.

## Files Changed

- `app/(dashboard)/sales/leads/*` (modified) – add conversion CTA
- `lib/actions/leads/convert-to-client.ts` (new) – server action scaffolding
- `lib/queries/threads.ts` (modified) – support reassignment by client id

## Notes

- This task defines the flow and data moves; actual schema changes to enums should follow the Drizzle migration workflow.
- Ensure all changes maintain soft-delete semantics; never hard-delete during conversion.

# Task 5.7: Attachments & Storage Policy (Supabase Storage)

## Overview

Define how raw emails and attachments are stored and referenced using Supabase Storage, with DB pointers, basic integrity metadata, and future-ready scanning hooks.

## Dependencies

- 5.1 (Threads & Messages Schema)

## Deliverables

1) Storage buckets

- `emails` bucket – raw `.eml` files
- `attachments` bucket – message attachments (any mime)

2) Path conventions

- Emails: `emails/{provider}/{accountId}/{yyyy}/{mm}/{dd}/{externalId}.eml`
- Attachments: `attachments/{messageId}/{sha256}-{safeFilename}`

3) DB pointers

- `email_raw.storage_path` points to `.eml`
- `message_attachments.storage_path` points to attachment objects
- Store `size_bytes` and `sha256` for integrity checks

4) Access controls

- All access server-side; generate signed URLs when needed. Never expose buckets publicly.
- Redact paths in logs; include only ids.

5) Scanning (stub)

- Add a `scanned_at` and `scan_status` field to `message_attachments` in a later iteration; integrate AV scanning before enabling downloads.

## Acceptance Criteria

- Clear storage paths and DB pointers for emails and attachments.
- New attachments persist via `message_attachments` with metadata.

## Files Changed

- `lib/db/schema.ts` (modified) – ensure `message_attachments`
- `docs` only for this task; code added in later implementation tasks


# Task 4.2: GitHub Repository Schema

## Overview
Add database tables for linking GitHub repositories to projects and storing PR suggestions.

## Dependencies
- Task 4.1 (GitHub OAuth)

## Deliverables

### 1. Add `githubRepoLinks` table to `/lib/db/schema.ts`

```typescript
export const githubRepoLinks = pgTable(
  'github_repo_links',
  {
    id: uuid().defaultRandom().primaryKey().notNull(),
    projectId: uuid('project_id').notNull(),
    repoOwner: text('repo_owner').notNull(), // GitHub org or user
    repoName: text('repo_name').notNull(),
    repoFullName: text('repo_full_name').notNull(), // owner/repo
    repoId: bigint('repo_id', { mode: 'number' }).notNull(),
    defaultBranch: text('default_branch').default('main').notNull(),
    isActive: boolean('is_active').default(true).notNull(),
    linkedBy: uuid('linked_by').notNull(),
    createdAt: timestamp('created_at', { withTimezone: true, mode: 'string' })
      .default(sql`timezone('utc'::text, now())`)
      .notNull(),
    updatedAt: timestamp('updated_at', { withTimezone: true, mode: 'string' })
      .default(sql`timezone('utc'::text, now())`)
      .notNull(),
    deletedAt: timestamp('deleted_at', { withTimezone: true, mode: 'string' }),
  },
  table => [
    // One link per repo per project
    unique('github_repo_links_project_repo_key').on(table.projectId, table.repoFullName),
    // Index for project lookup
    index('idx_github_repo_links_project')
      .using('btree', table.projectId.asc().nullsLast().op('uuid_ops'))
      .where(sql`(deleted_at IS NULL)`),
    // Index for repo lookup
    index('idx_github_repo_links_repo')
      .using('btree', table.repoFullName.asc().nullsLast().op('text_ops'))
      .where(sql`(deleted_at IS NULL)`),
    // Foreign keys
    foreignKey({
      columns: [table.projectId],
      foreignColumns: [projects.id],
      name: 'github_repo_links_project_id_fkey',
    }).onDelete('cascade'),
    foreignKey({
      columns: [table.linkedBy],
      foreignColumns: [users.id],
      name: 'github_repo_links_linked_by_fkey',
    }),
    // RLS Policies
    pgPolicy('Admins manage github repo links', {
      as: 'permissive',
      for: 'all',
      to: ['public'],
      using: sql`is_admin()`,
    }),
    pgPolicy('Users view repo links for accessible projects', {
      as: 'permissive',
      for: 'select',
      to: ['public'],
      using: sql`(
        project_id IN (
          SELECT id FROM projects WHERE deleted_at IS NULL
          AND (created_by = auth.uid() OR client_id IN (
            SELECT client_id FROM client_members WHERE user_id = auth.uid() AND deleted_at IS NULL
          ))
        )
      )`,
    }),
  ]
)
```

### 2. Add enum and `prSuggestions` table to `/lib/db/schema.ts`

```typescript
export const prSuggestionStatus = pgEnum('pr_suggestion_status', [
  'DRAFT',     // AI generated, not reviewed
  'PENDING',   // User reviewed, awaiting approval
  'APPROVED',  // User approved, PR created
  'REJECTED',  // User rejected
  'FAILED',    // PR creation failed
])

export const prSuggestions = pgTable(
  'pr_suggestions',
  {
    id: uuid().defaultRandom().primaryKey().notNull(),
    taskSuggestionId: uuid('task_suggestion_id'), // Optional link to task suggestion
    emailMetadataId: uuid('email_metadata_id'), // Optional direct email link
    githubRepoLinkId: uuid('github_repo_link_id').notNull(),
    suggestedTitle: text('suggested_title').notNull(),
    suggestedBody: text('suggested_body').notNull(), // Markdown PR description
    suggestedBranch: text('suggested_branch'),
    suggestedBaseBranch: text('suggested_base_branch').default('main'),
    suggestedLabels: text('suggested_labels').array().default([]),
    suggestedAssignees: text('suggested_assignees').array().default([]), // GitHub usernames
    confidence: numeric({ precision: 3, scale: 2 }).notNull(), // 0.00-1.00 (CHECK constraint enforces range)
    reasoning: text(),
    status: prSuggestionStatus().default('DRAFT').notNull(),
    reviewedBy: uuid('reviewed_by'),
    reviewedAt: timestamp('reviewed_at', { withTimezone: true, mode: 'string' }),
    createdPrNumber: integer('created_pr_number'),
    createdPrUrl: text('created_pr_url'),
    errorMessage: text('error_message'),
    aiModelVersion: text('ai_model_version'),
    createdAt: timestamp('created_at', { withTimezone: true, mode: 'string' })
      .default(sql`timezone('utc'::text, now())`)
      .notNull(),
    updatedAt: timestamp('updated_at', { withTimezone: true, mode: 'string' })
      .default(sql`timezone('utc'::text, now())`)
      .notNull(),
    deletedAt: timestamp('deleted_at', { withTimezone: true, mode: 'string' }),
  },
  table => [
    // Index for pending suggestions
    index('idx_pr_suggestions_pending')
      .using('btree', table.status.asc().nullsLast())
      .where(sql`(deleted_at IS NULL AND status IN ('DRAFT', 'PENDING'))`),
    // Index for repo lookup
    index('idx_pr_suggestions_repo')
      .using('btree', table.githubRepoLinkId.asc().nullsLast().op('uuid_ops'))
      .where(sql`(deleted_at IS NULL)`),
    // Foreign keys
    foreignKey({
      columns: [table.taskSuggestionId],
      foreignColumns: [taskSuggestions.id],
      name: 'pr_suggestions_task_suggestion_id_fkey',
    }),
    foreignKey({
      columns: [table.emailMetadataId],
      foreignColumns: [emailMetadata.id],
      name: 'pr_suggestions_email_metadata_id_fkey',
    }),
    foreignKey({
      columns: [table.githubRepoLinkId],
      foreignColumns: [githubRepoLinks.id],
      name: 'pr_suggestions_github_repo_link_id_fkey',
    }).onDelete('cascade'),
    foreignKey({
      columns: [table.reviewedBy],
      foreignColumns: [users.id],
      name: 'pr_suggestions_reviewed_by_fkey',
    }),
    // Constraint: confidence must be between 0 and 1
    check(
      'pr_suggestions_confidence_range',
      sql`confidence >= 0 AND confidence <= 1`
    ),
    // RLS Policies
    pgPolicy('Admins manage pr suggestions', {
      as: 'permissive',
      for: 'all',
      to: ['public'],
      using: sql`is_admin()`,
    }),
  ]
)
```

### 3. Add relations to `/lib/db/relations.ts`

```typescript
import { githubRepoLinks, prSuggestions } from './schema'

export const githubRepoLinksRelations = relations(githubRepoLinks, ({ one, many }) => ({
  project: one(projects, {
    fields: [githubRepoLinks.projectId],
    references: [projects.id],
  }),
  linkedByUser: one(users, {
    fields: [githubRepoLinks.linkedBy],
    references: [users.id],
  }),
  prSuggestions: many(prSuggestions),
}))

export const prSuggestionsRelations = relations(prSuggestions, ({ one }) => ({
  taskSuggestion: one(taskSuggestions, {
    fields: [prSuggestions.taskSuggestionId],
    references: [taskSuggestions.id],
  }),
  email: one(emailMetadata, {
    fields: [prSuggestions.emailMetadataId],
    references: [emailMetadata.id],
  }),
  repoLink: one(githubRepoLinks, {
    fields: [prSuggestions.githubRepoLinkId],
    references: [githubRepoLinks.id],
  }),
  reviewedByUser: one(users, {
    fields: [prSuggestions.reviewedBy],
    references: [users.id],
  }),
}))

// Add to projectsRelations:
// githubRepos: many(githubRepoLinks),
```

### 4. Create TypeScript types in `/lib/types/github.ts`

```typescript
import type { InferSelectModel, InferInsertModel } from 'drizzle-orm'
import type { githubRepoLinks, prSuggestions } from '@/lib/db/schema'

export type GitHubRepoLink = InferSelectModel<typeof githubRepoLinks>
export type NewGitHubRepoLink = InferInsertModel<typeof githubRepoLinks>

export type PRSuggestion = InferSelectModel<typeof prSuggestions>
export type NewPRSuggestion = InferInsertModel<typeof prSuggestions>

export type PRSuggestionStatus = 'DRAFT' | 'PENDING' | 'APPROVED' | 'REJECTED' | 'FAILED'

export interface GitHubRepoLinkWithProject extends GitHubRepoLink {
  project: {
    id: string
    name: string
  }
}

export interface PRSuggestionWithContext extends PRSuggestion {
  repoLink: {
    repoFullName: string
    defaultBranch: string
  }
  email?: {
    subject: string | null
    fromEmail: string
  } | null
}
```

### 5. Generate and run migration

```bash
npm run db:generate
npm run db:migrate
```

## Schema Design Notes

### githubRepoLinks Table
| Column | Purpose |
|--------|---------|
| `projectId` | Which project this repo is linked to |
| `repoOwner` | GitHub org or username |
| `repoName` | Repository name |
| `repoFullName` | `owner/repo` format |
| `repoId` | GitHub's numeric repo ID |
| `defaultBranch` | Default branch for PRs |
| `isActive` | Can disable without deleting |
| `linkedBy` | Who created the link |

### prSuggestions Table
| Column | Purpose |
|--------|---------|
| `taskSuggestionId` | Link to task suggestion if derived from one |
| `emailMetadataId` | Direct email link if applicable |
| `githubRepoLinkId` | Target repository |
| `suggestedTitle` | PR title |
| `suggestedBody` | PR description (markdown) |
| `suggestedBranch` | Feature branch name |
| `suggestedBaseBranch` | Target branch |
| `suggestedLabels` | PR labels |
| `suggestedAssignees` | GitHub usernames |
| `confidence` | AI confidence |
| `status` | Review workflow |
| `createdPrNumber` | GitHub PR # if created |
| `createdPrUrl` | GitHub PR URL |
| `errorMessage` | If creation failed |

## Acceptance Criteria

- [ ] Enum `pr_suggestion_status` created
- [ ] Table `github_repo_links` created with all columns
- [ ] Table `pr_suggestions` created with all columns
- [ ] Unique constraint on project+repo
- [ ] All indexes created
- [ ] Foreign keys with cascades
- [ ] Relations added
- [ ] TypeScript types exported
- [ ] Migration generated and applied

## Files Changed
- `lib/db/schema.ts` (modified - add tables)
- `lib/db/relations.ts` (modified - add relations)
- `lib/types/github.ts` (new)
- `drizzle/migrations/` (new migration file)

## Migration Details

**Migration Number:** `0011_github_integration.sql`

**Risk Level:** MEDIUM - Creates new tables with FK to existing `projects` table and Phase 3 tables.

**Dependencies:**
- `projects` table (from baseline)
- `task_suggestions` table (from migration 0010)
- `email_metadata` table (from migration 0009)

## Local Migration Testing Checklist

Before deploying to production, complete this checklist:

```bash
# 1. Generate the migration
npm run db:generate -- --name github_integration

# 2. Review generated SQL - verify FK definitions
cat drizzle/migrations/0011_github_integration.sql

# 3. Apply to LOCAL Supabase database
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres npm run db:migrate
```

### Verification Steps

```sql
-- Verify tables
\d github_repo_links
\d pr_suggestions

-- Verify enum
SELECT enum_range(NULL::pr_suggestion_status);

-- Verify indexes
\di+ idx_github_repo_links_*
\di+ idx_pr_suggestions_*

-- Test unique constraint on project+repo
INSERT INTO github_repo_links (project_id, repo_owner, repo_name, repo_full_name, repo_id, linked_by)
VALUES ('00000000-0000-0000-0000-000000000001', 'owner', 'repo', 'owner/repo', 123, '00000000-0000-0000-0000-000000000002');
-- Second insert with same project+repo should fail:
INSERT INTO github_repo_links (project_id, repo_owner, repo_name, repo_full_name, repo_id, linked_by)
VALUES ('00000000-0000-0000-0000-000000000001', 'owner', 'repo', 'owner/repo', 456, '00000000-0000-0000-0000-000000000002');
-- Expected: unique constraint violation

-- Test CHECK constraint: confidence must be 0-1
INSERT INTO pr_suggestions (github_repo_link_id, suggested_title, suggested_body, confidence)
VALUES ('00000000-0000-0000-0000-000000000001', 'Test PR', 'Body', 2.00);
-- Expected: check constraint "pr_suggestions_confidence_range" violated

-- Clean up
DELETE FROM github_repo_links WHERE repo_owner = 'owner';
```

### Rollback Plan

If issues occur:
```sql
DROP TABLE IF EXISTS pr_suggestions CASCADE;
DROP TABLE IF EXISTS github_repo_links CASCADE;
DROP TYPE IF EXISTS pr_suggestion_status;
```

Then remove the migration file and re-run `db:generate`.

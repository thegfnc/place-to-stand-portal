# Task 5.1: Threads and Messages Schema

## Overview

Introduce a generic Threads + Messages model owned by Clients so multiple input modalities (email, chat, voice memo, document, form submissions, transcripts) can be appended to a single canonical thread. This enables unified context, AI thread naming, and downstream task/project updates. Raw emails and attachments will be stored in Supabase Storage with DB pointers.

## Dependencies

- 2.1 (Client Contacts Schema) – for people/addresses linked to clients
- 2.3 (Email Metadata Schema) – reuse email metadata where applicable

## Deliverables

1) Database schema additions (Drizzle) – define new tables in `lib/db/schema.ts` and relations in `lib/db/relations.ts`:

- `threads`
  - `id` (uuid, pk)
  - `client_id` (uuid, not null, fk → `clients.id`)
  - `title` (text, nullable; AI/UX generated; can be empty initially)
  - `status` (enum: `open`, `archived`; default `open`)
  - `created_by` (uuid, nullable; internal user)
  - `created_at`/`updated_at` (timestamps)
  - `deleted_at` (timestamp, nullable; soft delete)
  - Index: `(client_id, status)`, `(updated_at desc)`

- `messages`
  - `id` (uuid, pk)
  - `thread_id` (uuid, fk → `threads.id`)
  - `type` (enum: `email`, `chat`, `voice_memo`, `document`, `form`, `transcript`)
  - `author_kind` (enum: `internal_user`, `external_contact`, `system`)
  - `author_id` (uuid, nullable) – user/contact id depending on `author_kind`
  - `participants_json` (jsonb, nullable) – normalized from/to/cc or chat participants
  - `body_text` (text, nullable) – normalized, safe text content
  - `body_json` (jsonb, nullable) – rich payload for structured types
  - `external_id` (text, nullable) – e.g., Gmail message/id for idempotency
  - `source` (text, nullable) – e.g., `gmail`, `portal`, `web_form`
  - `created_by` (uuid, nullable; internal user if authored in portal)
  - `created_at` (timestamp)
  - `deleted_at` (timestamp, nullable; soft delete)
  - Index: `(thread_id, created_at)`; unique `(type, external_id)` when available

- `email_raw`
  - `id` (uuid, pk)
  - `message_external_id` (text, unique) – stable Gmail id
  - `storage_path` (text) – Supabase Storage path to `.eml`
  - `headers_json` (jsonb) – parsed headers map
  - `attachments_manifest` (jsonb) – list of attachment metadata references
  - `size_bytes` (integer)
  - `sha256` (text)
  - `created_at` (timestamp)
  - Index: `(created_at desc)`

- `message_attachments`
  - `id` (uuid, pk)
  - `message_id` (uuid, fk → `messages.id`)
  - `filename` (text)
  - `mime_type` (text)
  - `size_bytes` (integer)
  - `sha256` (text)
  - `storage_path` (text) – Supabase Storage object path
  - `created_at` (timestamp)
  - Index: `(message_id)`

- `email_summaries`
  - `id` (uuid, pk)
  - `email_raw_id` (uuid, fk → `email_raw.id`)
  - `summary` (text) – AI summary of email + attachments
  - `entities_json` (jsonb) – extracted people, organizations, dates
  - `created_at` (timestamp)

- `email_classifications`
  - `id` (uuid, pk)
  - `email_raw_id` (uuid, fk → `email_raw.id`)
  - `category` (text) – e.g., `status_update`, `request`, `invoice`, `scheduling`
  - `confidence` (numeric)
  - `created_at` (timestamp)

2) Zod schemas – add `lib/zod/threads.ts` with shared zod types for thread and message payloads to maintain server-client parity (strict mode, no `any`). Include `author_kind`, `participants_json`.

3) Authorization – ensure server-side guards in any queries touching these tables use `lib/auth/permissions.ts` helpers. All access occurs server-side (RLS disabled).

4) Migrations – after editing the schema files:

- `npm run db:generate -- --name threads_messages_init`
- Review SQL under `drizzle/migrations/`
- `npm run db:migrate`

5) Soft deletes – all new tables must use `deleted_at` for soft-deletion. All default queries should filter out soft-deleted rows.

6) Unassigned strategy – allow `threads.client_id = NULL` and surface a Triage view in UI to link threads/messages to a client. Linking creates identity associations to auto-link future messages.

## Acceptance Criteria

- Can create a `thread` for a `client` and append `messages` of varying `type`.
- Emails can be ingested with raw RFC822 stored in Supabase Storage (`email_raw.storage_path`) and linked via `messages.external_id`.
- Classifications and summaries can be written to `email_classifications` and `email_summaries` for a given `email_raw` row.
- Zod types exist and are used in any routes/services created later in Phase 5.
- All access is gated via server-side authorization helpers.

## Files Changed

- `lib/db/schema.ts` (modified)
- `lib/db/relations.ts` (modified)
- `lib/zod/threads.ts` (new)
- `lib/db/migrations/*` (generated)

## Notes

- Prefer generic, future-proof fields. If a message type needs additional specifics, include them in `body_json` with a compact schema.
- Avoid premature denormalization; lean on indexes for performance and materialize later if needed.

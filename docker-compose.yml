# Docker Compose for Place to Stand Portal
# This setup provides PostgreSQL and the Next.js application for local development

name: pts-portal

services:
  # ================================
  # PostgreSQL Database
  # ================================
  # NOTE: If you're running Supabase locally (port 54322),
  # this service can be disabled - the app can use Supabase's PostgreSQL directly
  db:
    image: postgres:16-alpine
    container_name: pts-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "54323:5432"  # Changed from 54322 to avoid conflict with Supabase
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # Next.js Application (Development)
  # ================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: pts-app
    restart: unless-stopped
    ports:
      - "3002:3000"  # Map to 3002 to avoid conflict with local dev servers
    env_file:
      - env.local
    environment:
      # Use Supabase's PostgreSQL running on host (port 54322)
      - DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:54322/postgres
      # Override Supabase URL for Docker networking
      - NEXT_PUBLIC_SUPABASE_URL=http://host.docker.internal:54321
    volumes:
      # Mount source code for hot reloading
      - .:/app
      # Preserve node_modules from container
      - /app/node_modules
      # Preserve .next build cache
      - /app/.next
    # Remove db dependency since we're using host's Supabase PostgreSQL
    # depends_on:
    #   db:
    #     condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ================================
  # Supabase Local Stack (Optional)
  # Uncomment to run full Supabase locally
  # ================================
  # supabase-studio:
  #   image: supabase/studio:latest
  #   container_name: pts-supabase-studio
  #   ports:
  #     - "54323:3000"
  #   environment:
  #     SUPABASE_URL: http://supabase-kong:8000
  #     STUDIO_PG_META_URL: http://supabase-meta:8080
  #   depends_on:
  #     - supabase-kong

volumes:
  postgres_data:
    driver: local

networks:
  default:
    name: pts-network
